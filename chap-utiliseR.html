<!DOCTYPE html>
<html lang="fr-FR">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2 Utiliser R | Travailler avec R</title>
<meta name="author" content="Eric Marcon">
<meta name="description" content="La documentation consacrée à l’apprentissage de R est florissante. Les ouvrages suivants sont une sélection arbitraire mais utile pour progresser: L’Introduction à R et au tidyverse (Barnier 2020)...">
<meta name="generator" content="bookdown 0.36 with bs4_book()">
<meta property="og:title" content="2 Utiliser R | Travailler avec R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ericmarcon.github.io/travailleR/chap-utiliseR.html">
<meta property="og:description" content="La documentation consacrée à l’apprentissage de R est florissante. Les ouvrages suivants sont une sélection arbitraire mais utile pour progresser: L’Introduction à R et au tidyverse (Barnier 2020)...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2 Utiliser R | Travailler avec R">
<meta name="twitter:description" content="La documentation consacrée à l’apprentissage de R est florissante. Les ouvrages suivants sont une sélection arbitraire mais utile pour progresser: L’Introduction à R et au tidyverse (Barnier 2020)...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-7NVD1TWMCJ"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7NVD1TWMCJ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Travailler avec R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Présentation</a></li>
<li><a class="" href="chap-logiciels.html"><span class="header-section-number">1</span> Logiciels</a></li>
<li><a class="active" href="chap-utiliseR.html"><span class="header-section-number">2</span> Utiliser R</a></li>
<li><a class="" href="chap-git.html"><span class="header-section-number">3</span> Git et GitHub</a></li>
<li><a class="" href="chap-rediger.html"><span class="header-section-number">4</span> Rédiger</a></li>
<li><a class="" href="chap-package.html"><span class="header-section-number">5</span> Package</a></li>
<li><a class="" href="chap-ci.html"><span class="header-section-number">6</span> Intégration continue</a></li>
<li><a class="" href="chap-shiny.html"><span class="header-section-number">7</span> Shiny</a></li>
<li><a class="" href="chap-enseigner.html"><span class="header-section-number">8</span> Enseigner avec R</a></li>
<li><a class="" href="chap-conclusion.html"><span class="header-section-number">9</span> Conclusion</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/EricMarcon/travailleR">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-utiliseR" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Utiliser R<a class="anchor" aria-label="anchor" href="#chap-utiliseR"><i class="fas fa-link"></i></a>
</h1>
<p>La documentation consacrée à l’apprentissage de R est florissante.
Les ouvrages suivants sont une sélection arbitraire mais utile pour progresser:</p>
<ul>
<li>L’<a href="https://juba.github.io/tidyverse/">Introduction à R et au tidyverse</a> <span class="citation">(<a href="references.html#ref-Barnier2020" role="doc-biblioref">Barnier 2020</a>)</span> est un excellent cours de prise en main.</li>
<li>
<a href="http://adv-r.had.co.nz/">Advanced R</a> <span class="citation">(<a href="references.html#ref-Wickham2014" role="doc-biblioref">Wickham 2014</a>)</span> est la référence pour maîtriser les subtilités du langage et bien comprendre le fonctionnement de R.</li>
<li>
<a href="https://r4ds.had.co.nz/">R for Data Science</a> <span class="citation">(<a href="references.html#ref-Wickham2016" role="doc-biblioref">Wickham et Grolemund 2016</a>)</span> présente une méthode de travail complète, cohérente avec le tidyverse.</li>
<li>Enfin, <a href="https://csgillespie.github.io/efficientR/">Efficient R programming</a> <span class="citation">(<a href="references.html#ref-Gillespie2016" role="doc-biblioref">Gillespie et Lovelace 2016</a>)</span> traite de l’optimisation du code.</li>
</ul>
<p>Quelques aspects avancés du codage sont vus ici.
Des précisions sur les différents langages de R sont utiles pour la création de packages.
Les environnements sont présentés ensuite, pour la bonne compréhension de la recherche des objets appelés par le code.
Enfin, l’optimisation des performances du code est traitée en détail (boucles, code C++ et parallélisation) et illustrée par une étude de cas.</p>
<div id="les-langages-de-r" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Les langages de R<a class="anchor" aria-label="anchor" href="#les-langages-de-r"><i class="fas fa-link"></i></a>
</h2>
<p>R comprend plusieurs langages de programmation.
Le plus courant est S3, mais ce n’est pas le seul<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://adv-r.had.co.nz/OO-essentials.html" class="uri"&gt;https://adv-r.had.co.nz/OO-essentials.html&lt;/a&gt;&lt;/p&gt;'><sup>17</sup></a>.</p>
<div id="base" class="section level3" number="2.1.1">
<h3>
<span class="header-section-number">2.1.1</span> Base<a class="anchor" aria-label="anchor" href="#base"><i class="fas fa-link"></i></a>
</h3>
<p>Le cœur de R est constitué des fonctions primitives et structures de données de base comme la fonction <code>sum</code> et les données de type <code>matrix</code>:</p>
<p></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "base"</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "builtin"</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "base"</code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "double"</code></pre>
<p></p>
<p>Le package <strong>pryr</strong> permet d’afficher le langage dans lequel des objets sont définis.
La fonction <code><a href="https://rdrr.io/r/base/typeof.html">typeof()</a></code> affiche le type de stockage interne des objets:</p>
<ul>
<li>la fonction <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> appartient au langage de base de R et est une fonction primitive (<em>builtin</em>);</li>
<li>les éléments de la matrice numérique contenant un seul 1 sont des réels à double précision, et la matrice elle-même est définie dans le langage de base.</li>
</ul>
<p>Les fonctions primitives sont codées en C et sont très rapides.
Elles sont toujours disponibles, quels que soient les packages chargés.
Leur usage est donc à privilégier.</p>
</div>
<div id="sec:S3" class="section level3" number="2.1.2">
<h3>
<span class="header-section-number">2.1.2</span> S3<a class="anchor" aria-label="anchor" href="#sec:S3"><i class="fas fa-link"></i></a>
</h3>
<p>S3 est le langage le plus utilisé, souvent le seul connu par les utilisateurs de R.</p>
<p>C’est un langage orienté objet dans lequel les classes, c’est-à-dire le type des objets, sont déclaratives.</p>
<p></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MonPrenom</span> <span class="op">&lt;-</span> <span class="st">"Eric"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">MonPrenom</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Prenom"</span></span></code></pre></div>
<p></p>
<p>La variable <code>MonPrenom</code> est ici de classe “Prenom” par une simple déclaration.</p>
<p>Contrairement au fonctionnement d’un langage orienté objet classique<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://www.troispointzero.fr/le-blog/introduction-a-la-programmation-orientee-objet-poo/" class="uri"&gt;https://www.troispointzero.fr/le-blog/introduction-a-la-programmation-orientee-objet-poo/&lt;/a&gt;&lt;/p&gt;'><sup>18</sup></a>, les méthodes S3 sont liées aux fonctions, pas aux objets.</p>
<p></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Affichage par défaut</span></span>
<span><span class="va">MonPrenom</span></span></code></pre></div>
<pre><code>## [1] "Eric"
## attr(,"class")
## [1] "Prenom"</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print.Prenom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Le prénom est"</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="co"># Affichage modifié</span></span>
<span><span class="va">MonPrenom</span></span></code></pre></div>
<pre><code>## Le prénom est Eric</code></pre>
<p></p>
<p>Dans cet exemple, la méthode <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> appliquée à la classe “Prenom” est modifiée.
Dans un langage orienté objet classique, la méthode serait définie dans la classe <code>Prenom</code>.
Dans R, les méthodes sont définies à partir de méthodes génériques.</p>
<p><code>print</code> est une méthode générique (“un générique”) déclaré dans <strong>base</strong>.</p>
<p></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">print</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "base"</code></pre>
<p></p>
<p>Son code se résume à une déclaration <code>UseMethod("print")</code>:</p>
<p></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print</span></span></code></pre></div>
<pre><code>## function (x, ...) 
## UseMethod("print")
## &lt;bytecode: 0x7fe0b9e9f4b8&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>Il existe beaucoup de méthodes S3 pour <code>print</code>:</p>
<p></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="st">"print"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "print.acf"               "print.activeConcordance"
## [3] "print.AES"               "print.all_vars"         
## [5] "print.anova"             "print.any_vars"</code></pre>
<p></p>
<p>Chacune s’applique à une classe. <code>print.default</code> est utilisée en dernier ressort et s’appuie sur le type de l’objet, pas sur sa classe S3.</p>
<p></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">MonPrenom</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "character"</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">MonPrenom</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "S3"</code></pre>
<p></p>
<p>Un objet peut appartenir à plusieurs classes, ce qui permet une forme d’héritage des méthodes.
Dans un langage orienté objet classique, l’héritage permet de définir des classes plus précises (“PrenomFrancais”) qui héritent de classes plus générales (“Prenom”) et bénéficient de cette façon de leurs méthodes sans avoir à les redéfinir.
Dans R, l’héritage consiste simplement à déclarer un vecteur de classes de plus en plus larges pour un objet:</p>
<p></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Définition des classes par un vecteur</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">MonPrenom</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PrenomFrancais"</span>, <span class="st">"Prenom"</span><span class="op">)</span></span>
<span><span class="co"># Ecriture alternative, avec inherits()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">MonPrenom</span>, what <span class="op">=</span> <span class="st">"PrenomFrancais"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">MonPrenom</span>, what <span class="op">=</span> <span class="st">"Prenom"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p></p>
<p>Le générique cherche une méthode pour chaque classe, dans l’ordre de leur déclaration.</p>
<p></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print.PrenomFrancais</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Prénom français:"</span>,</span>
<span>    <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">MonPrenom</span></span></code></pre></div>
<pre><code>## Prénom français: Eric</code></pre>
<p></p>
<p>En résumé, S3 est le langage courant de R.
Presque tous les packages sont écrits en S3.
Les génériques sont partout mais passent inaperçus, par exemple dans des packages:</p>
<p></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/EricMarcon/entropart">"entropart"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">.S3methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"SpeciesDistribution"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] autoplot plot    
## see '?methods' for accessing help and source code</code></pre>
<p></p>
<p>La fonction <code><a href="https://rdrr.io/r/utils/methods.html">.S3methods()</a></code> permet d’afficher toutes les méthodes disponibles pour une classe, par opposition à <code><a href="https://rdrr.io/r/utils/methods.html">methods()</a></code> qui affiche toutes les classes pour lesquelles la méthode passée en argument est définie.</p>
<p>De nombreuses fonctions primitives de R sont des méthodes génériques.
Utiliser l’aide <code><a href="https://rdrr.io/r/base/InternalMethods.html">help(InternalMethods)</a></code> pour les découvrir.</p>
</div>
<div id="s4" class="section level3" number="2.1.3">
<h3>
<span class="header-section-number">2.1.3</span> S4<a class="anchor" aria-label="anchor" href="#s4"><i class="fas fa-link"></i></a>
</h3>
<p>S4 est une évolution de S3 qui structure les classes pour se rapprocher d’un langage orienté objet classique:</p>
<ul>
<li>les classes doivent être définies explicitement, pas simplement déclarées;</li>
<li>les attributs (c’est-à-dire les variables décrivant les objets), appelés <em>slots</em>, sont déclarés explicitement;</li>
<li>le constructeur, c’est-à-dire la méthode qui crée un nouvelle instance d’une classe (c’est-à-dire une variable contenant un objet de la classe), est explicite.</li>
</ul>
<p>En reprenant l’exemple précédent, la syntaxe S4 est la suivante:</p>
<p></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Définition de la classe Personne, avec ses slots</span></span>
<span><span class="kw">setClass</span><span class="op">(</span><span class="st">"Personne"</span>,  </span>
<span>         slots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Nom <span class="op">=</span> <span class="st">"character"</span>, Prenom <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Construction d'une instance</span></span>
<span><span class="va">Moi</span> <span class="op">&lt;-</span> <span class="fu">new</span><span class="op">(</span><span class="st">"Personne"</span>, Nom <span class="op">=</span> <span class="st">"Marcon"</span>, Prenom <span class="op">=</span> <span class="st">"Eric"</span><span class="op">)</span></span>
<span><span class="co"># Langage</span></span>
<span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">Moi</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "S4"</code></pre>
<p></p>
<p>Les méthodes appartiennent toujours aux fonctions.
Elles sont déclarées par la fonction <code><a href="https://rdrr.io/r/methods/setMethod.html">setMethod()</a></code>:</p>
<p></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">setMethod</span><span class="op">(</span><span class="st">"print"</span>, signature <span class="op">=</span> <span class="st">"Personne"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"La personne est:"</span>, <span class="va">x</span><span class="op">@</span><span class="va">Prenom</span>, <span class="va">x</span><span class="op">@</span><span class="va">Nom</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">Moi</span><span class="op">)</span></span></code></pre></div>
<pre><code>## La personne est: Eric Marcon</code></pre>
<p></p>
<p>Les attributs sont appelés par la syntaxe <code>variable@slot</code>.</p>
<p>En résumé, S4 est plus rigoureux que S3.
Quelques packages sur CRAN : <strong>Matrix</strong>, <strong>sp</strong>, <strong>odbc</strong>… et beaucoup sur Bioconductor sont écrits en S4 mais le langage est maintenant clairement délaissé au profit de S3, notamment à cause du succès du <strong>tidyverse</strong>.</p>
</div>
<div id="rc" class="section level3" number="2.1.4">
<h3>
<span class="header-section-number">2.1.4</span> RC<a class="anchor" aria-label="anchor" href="#rc"><i class="fas fa-link"></i></a>
</h3>
<p>RC a été introduit dans R 2.12 (2010) avec le package <strong>methods</strong>.</p>
<p>Les méthodes appartiennent aux classes, comme en C++: elles sont déclarées dans la classe et appelées à partir des objets.</p>
<p></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"methods"</span><span class="op">)</span></span>
<span><span class="co"># Déclaration de la classe</span></span>
<span><span class="va">PersonneRC</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/methods/refClass.html">setRefClass</a></span><span class="op">(</span><span class="st">"PersonneRC"</span>, </span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Nom <span class="op">=</span> <span class="st">"character"</span>, Prenom <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span>,</span>
<span>    methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>print <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">Prenom</span>, <span class="va">Nom</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Constructeur</span></span>
<span><span class="va">MoiRC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/new.html">new</a></span><span class="op">(</span><span class="st">"PersonneRC"</span>, Nom <span class="op">=</span> <span class="st">"Marcon"</span>, Prenom <span class="op">=</span><span class="st">"Eric"</span><span class="op">)</span></span>
<span><span class="co"># Langage</span></span>
<span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">MoiRC</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "RC"</code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Appel de la méthode print</span></span>
<span><span class="va">MoiRC</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Eric Marcon</code></pre>
<p></p>
<p>RC est un langage confidentiel, bien que ce soit le premier “vrai” langage orienté objet de R.</p>
</div>
<div id="s6" class="section level3" number="2.1.5">
<h3>
<span class="header-section-number">2.1.5</span> S6<a class="anchor" aria-label="anchor" href="#s6"><i class="fas fa-link"></i></a>
</h3>
<p>S6<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r6.r-lib.org/" class="uri"&gt;https://r6.r-lib.org/&lt;/a&gt;&lt;/p&gt;'><sup>19</sup></a> perfectionne RC mais n’est pas inclus dans R: il nécessite d’installer son package.</p>
<p>Les attributs et les méthodes peuvent être publics ou privés.
Une méthode <code><a href="https://rdrr.io/r/methods/new.html">initialize()</a></code> est utilisée comme constructeur.</p>
<p></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r6.r-lib.org">R6</a></span><span class="op">)</span></span>
<span><span class="va">PersonneR6</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"PersonneR6"</span>, public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Nom <span class="op">=</span> <span class="st">"character"</span>,</span>
<span>    Prenom <span class="op">=</span> <span class="st">"character"</span>, initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">Nom</span> <span class="op">=</span> <span class="cn">NA</span>, <span class="va">Prenom</span> <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">self</span><span class="op">$</span><span class="va">Nom</span> <span class="op">&lt;-</span> <span class="va">Nom</span></span>
<span>        <span class="va">self</span><span class="op">$</span><span class="va">Prenom</span> <span class="op">&lt;-</span> <span class="va">Prenom</span></span>
<span>    <span class="op">}</span>, print <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">Prenom</span>, <span class="va">self</span><span class="op">$</span><span class="va">Nom</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">MoiR6</span> <span class="op">&lt;-</span> <span class="va">PersonneR6</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>Nom <span class="op">=</span> <span class="st">"Marcon"</span>, Prenom <span class="op">=</span> <span class="st">"Eric"</span><span class="op">)</span></span>
<span><span class="va">MoiR6</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Eric Marcon</code></pre>
<p></p>
<p>S6 permet de programmer rigoureusement en objet mais est très peu utilisé.
Les performances de S6 sont bien supérieures à celles de RC mais sont inférieures à celles de S3<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r6.r-lib.org/articles/Performance.html" class="uri"&gt;https://r6.r-lib.org/articles/Performance.html&lt;/a&gt;&lt;/p&gt;'><sup>20</sup></a>.</p>
<p>La non-inclusion de R6 à R est montrée par <strong>pryr</strong>:</p>
<p></p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">MoiR6</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "S3"</code></pre>
<p></p>
</div>
<div id="tidyverse" class="section level3" number="2.1.6">
<h3>
<span class="header-section-number">2.1.6</span> Tidyverse<a class="anchor" aria-label="anchor" href="#tidyverse"><i class="fas fa-link"></i></a>
</h3>
<p>Le tidyverse est un ensemble de packages cohérents qui ont fait évoluer la façon de programmer R.
L’ensemble des packages indispensables peut être chargé par le package <strong>tidyverse</strong> qui n’a pas d’autre utilité:</p>
<p></p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Il ne s’agit pas d’un nouveau langage à proprement parler mais plutôt d’une extension de S3, avec de profondes modifications techniques, notamment l’évaluation non conventionnelle des expressions<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://dplyr.tidyverse.org/articles/programming.html" class="uri"&gt;https://dplyr.tidyverse.org/articles/programming.html&lt;/a&gt;&lt;/p&gt;'><sup>21</sup></a>, qu’il n’est pas essentiel de maîtriser en détail.</p>
<p>Ses principes sont inscrits dans un manifeste<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html" class="uri"&gt;https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html&lt;/a&gt;&lt;/p&gt;'><sup>22</sup></a>.
Son apport le plus visible pour l’utilisateur sont l’enchaînement des commandes dans un flux (pipeline de code).</p>
<p>En programmation standard, l’enchaînement des fonctions s’écrit par emboîtements successifs, ce qui en rend la lecture difficile, surtout quand des arguments sont nécessaires:</p>
<p></p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Logarithme de base 2 de la moyenne de 100 tirages</span></span>
<span><span class="co"># aléatoires dans une loi uniforme</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>, base <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -1.127903</code></pre>
<p></p>
<p>Dans le tidyverse, les fonctions s’enchaînent, ce qui correspond souvent mieux à la réflexion du programmeur sur le traitement des données:</p>
<p></p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 100 tirages aléatoires dans une loi uniforme</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Moyenne</span></span>
<span>  <span class="va">mean</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Logarithme</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span>base<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -0.9772102</code></pre>
<p></p>
<p>Le tuyau <code>%&gt;%</code> est un opérateur qui appelle la fonction suivante en lui passant comme premier argument le résultat de la fonction précédente.
Les arguments supplémentaires sont passés normalement: pour la lisibilité du code, il est indispensable de les nommer.
La plupart des fonctions de R sont utilisables sans difficultés dans le tidyverse bien qu’elles n’aient pas été prévues pour cela: il suffit que leur premier argument soit les données à traiter.</p>
<p>Le pipeline ne permet de passer qu’une seule valeur à la fonction suivante, ce qui interdit les fonctions multidimensionnelles, de type <code>f(x,y)</code>.
La structure de données préférée est le <em>tibble</em>, qui est un dataframe amélioré: sa méthode <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> est plus lisible, et il corrige quelques comportements non-intuitifs des dataframes, comme la conversion automatique en vecteurs des dataframes à une seule colonne.
Les colonnes du dataframe ou du tibble permettent de passer autant de données que nécessaire.</p>
<p>Enfin, la visualisation des données est prise en charge par <strong>ggplot2</strong> qui s’appuie sur une grammaire des graphiques <span class="citation">(<a href="references.html#ref-Wickham2010" role="doc-biblioref">Wickham 2010</a>)</span> solide sur le plan théorique.
Schématiquement, un graphique est construit selon le modèle suivant:</p>
<pre><code>ggplot(data = &lt;DATA&gt;) + 
  &lt;GEOM_FUNCTION&gt;(
     mapping = aes(&lt;MAPPINGS&gt;),
     stat = &lt;STAT&gt;, 
     position = &lt;POSITION&gt;
  ) +
  &lt;COORDINATE_FUNCTION&gt; +
  &lt;FACET_FUNCTION&gt;</code></pre>
<ul>
<li>les données sont obligatoirement un dataframe;</li>
<li>la géométrie est le type de graphique choisi (points, lignes, histogrammes ou autre);</li>
<li>l’esthétique (fonction <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code>) désigne ce qui est représenté: c’est la correspondance entre les colonnes du dataframe et les éléments nécessaires à la géométrie;</li>
<li>la statistique est le traitement appliqué aux données avant de les transmettre à la géométrie (souvent “identity”, c’est-à-dire aucune transformation mais “boxplot” pour une boîte à moustache).
Les données peuvent être transformées par une fonction d’échelle, comme <code><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10()</a></code>;</li>
<li>la position est l’emplacement des objets sur le graphique (souvent “identity”; “stack” pour un histogramme empilé, “jitter” pour déplacer légèrement les points superposés dans un <code>geom_point</code>);</li>
<li>les coordonnées définissent l’affichage du graphique (<code><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_fixed()</a></code> pour ne pas déformer une carte par exemple) ;</li>
<li>enfin, les facettes offrent la possibilité d’afficher plusieurs aspects des mêmes données en produisant un graphique par modalité d’une variable.</li>
</ul>
<p>L’ensemble formé par le pipeline et <strong>ggplot2</strong> permet des traitements complexes dans un code lisible.
La figure <a href="chap-utiliseR.html#fig:diamonds">2.1</a> montre le résultat du code suivant:</p>

<p></p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Données sur les diamants fournies par ggplot2</span></span>
<span><span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Ne conserver que les diamants de plus d'un demi-carat</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">carat</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Graphique : prix en fonction du poids</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">carat</span>, y <span class="op">=</span> <span class="va">price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Nuage de points</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co"># Echelle logarithmique</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co"># Régression linéaire</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:diamonds"></span>
<img src="travailleR_files/figure-html/diamonds-1.png" alt="Prix des diamants en fonction de leur poids. Démonstration du code de ggplot2 combiné au traitement de données du tidyverse." width="80%"><p class="caption">
Figure 2.1: Prix des diamants en fonction de leur poids. Démonstration du code de <strong>ggplot2</strong> combiné au traitement de données du tidyverse.
</p>
</div>
<p></p>
<p>Dans cette figure, deux géométries (nuage de points et régression linéaire) partagent la même esthétique (prix en fonction du poids en carats) qui est donc déclarée en amont, dans la fonction <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>.</p>
<p>Le tidyverse est documenté en détail dans <span class="citation">Wickham et Grolemund (<a href="references.html#ref-Wickham2016" role="doc-biblioref">2016</a>)</span> et <strong>ggplot2</strong> dans <span class="citation">Wickham (<a href="references.html#ref-Wickham2017" role="doc-biblioref">2017</a>)</span>.</p>
</div>
</div>
<div id="sec:environnements" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Environnements<a class="anchor" aria-label="anchor" href="#sec:environnements"><i class="fas fa-link"></i></a>
</h2>
<p>Les objets de R, données et fonctions, sont nommés.
Comme R est modulaire, avec la possibilité de lui ajouter un nombre indéterminé de packages, il est très probable que des conflits de nom apparaissent.
Pour les régler, R dispose d’un système rigoureux de précédence des noms: le code s’exécute dans un environnement défini, héritant d’environnements parents.</p>
<div id="organisation" class="section level3" number="2.2.1">
<h3>
<span class="header-section-number">2.2.1</span> Organisation<a class="anchor" aria-label="anchor" href="#organisation"><i class="fas fa-link"></i></a>
</h3>
<p>R démarre dans un environnement vide.
Chaque package chargé crée un environnement fils pour former une pile des environnements, dont chaque nouvel élément est appelé “fils” du précédent, qui est son “parent”.</p>
<p>La console se trouve dans l’environnement global, fils du dernier package chargé.</p>
<p></p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] ".GlobalEnv"         "package:R6"        
##  [3] "package:entropart"  "package:lubridate" 
##  [5] "package:forcats"    "package:stringr"   
##  [7] "package:dplyr"      "package:purrr"     
##  [9] "package:readr"      "package:tidyr"     
## [11] "package:tibble"     "package:ggplot2"   
## [13] "package:tidyverse"  "package:kableExtra"
## [15] "package:stats"      "package:graphics"  
## [17] "package:grDevices"  "package:utils"     
## [19] "package:datasets"   "package:methods"   
## [21] "Autoloads"          "package:base"</code></pre>
<p></p>
<p>Le code d’une fonction appelée de la console s’exécute dans un environnement fils de l’environnement global:</p>
<p></p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Environnement actuel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># La fonction f affiche son environnement</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Affichage de l'environnement de la fonction</span></span>
<span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;environment: 0x7fe0b90df0b0&gt;</code></pre>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Environnement parent de celui de la fonction</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">parent.env</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<p></p>
</div>
<div id="recherche" class="section level3" number="2.2.2">
<h3>
<span class="header-section-number">2.2.2</span> Recherche<a class="anchor" aria-label="anchor" href="#recherche"><i class="fas fa-link"></i></a>
</h3>
<p>La recherche des objets commence dans l’environnement local.
S’il n’est pas trouvé, il est cherché dans l’environnement parent, puis dans le parent du parent, jusqu’à l’épuisement des environnements qui génère une erreur indiquant que l’objet n’a pas été trouvé.</p>
<p>Exemple:</p>
<p></p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Variable q définie dans l'environnement global</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="st">"GlobalEnv"</span></span>
<span><span class="co"># Fonction définissant q dans son environnement</span></span>
<span><span class="va">qLocalFonction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="st">"Fonction"</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># La variable locale est retournée</span></span>
<span><span class="fu">qLocalFonction</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "Fonction"</code></pre>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fonction (mal écrite) utilisant une variable qu'elle ne</span></span>
<span><span class="co"># définit pas</span></span>
<span><span class="va">qGlobalEnv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># La variable de l'environnement global est retournée</span></span>
<span><span class="fu">qGlobalEnv</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "GlobalEnv"</code></pre>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Suppression de cette variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co"># La fonction base::q est retournée</span></span>
<span><span class="fu">qGlobalEnv</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## function (save = "default", status = 0, runLast = TRUE) 
## .Internal(quit(save, status, runLast))
## &lt;bytecode: 0x7fe0a8316e00&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>La variable <code>q</code> est définie dans l’environnement global.
La fonction <code>qLocalFonction</code> définit sa propre variable <code>q</code>.
L’appel de la fonction retourne la valeur locale de la fonction parce qu’elle se trouve dans l’environnement de la fonction.</p>
<p>La fonction <code>qGlobalEnv</code> retourne la variable <code>q</code> qu’elle ne définit pas localement.
Elle la recherche donc dans son environnement parent et trouve la variable définie dans l’environnement global.
En supprimant la variable de l’environnement global par <code>rm(q)</code>, la fonction <code>qGlobalEnv()</code> parcourt la pile des environnements jusqu’à trouver un objet nommé <code>q</code> dans le package <strong>base</strong>, qui est la fonction permettant de quitter R.
Elle aurait pu trouver un autre objet si un package contenant un objet <code>q</code> avait été chargé.</p>
<p>Pour éviter ce comportement erratique, une fonction ne doit <em>jamais</em> appeler un objet non défini dans son propre environnement.</p>
</div>
<div id="espaces-de-nom-des-packages" class="section level3" number="2.2.3">
<h3>
<span class="header-section-number">2.2.3</span> Espaces de nom des packages<a class="anchor" aria-label="anchor" href="#espaces-de-nom-des-packages"><i class="fas fa-link"></i></a>
</h3>
<p>Il est temps de définir précisément ce que les packages rendent visible.
Les packages contiennent des objets (fonctions et données) qu’ils <em>exportent</em> ou non.
Ils sont habituellement appelés par la fonction <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> qui effectue deux opérations:</p>
<ul>
<li>elle <em>charge</em> le package en mémoire, ce qui permet d’accéder à tous ses objets avec la syntaxe <code>package::objet</code> pour les objets exportés et <code>package:::objet</code> pour ceux qui ne le sont pas;</li>
<li>elle <em>attache</em> ensuite le package, ce qui place son environnement en haut de la pile.</li>
</ul>
<p>Il est possible de détacher un package avec la fonction <code><a href="https://rdrr.io/r/base/ns-load.html">unloadNamespace()</a></code> pour le retirer de la pile des environnements.
Exemple:</p>
<p></p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># entropart chargé et attaché</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/EricMarcon/entropart">"entropart"</a></span><span class="op">)</span></span>
<span><span class="co"># Est-il attaché ?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">isNamespaceLoaded</a></span><span class="op">(</span><span class="st">"entropart"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pile des environnements</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] ".GlobalEnv"         "package:R6"        
##  [3] "package:entropart"  "package:lubridate" 
##  [5] "package:forcats"    "package:stringr"   
##  [7] "package:dplyr"      "package:purrr"     
##  [9] "package:readr"      "package:tidyr"     
## [11] "package:tibble"     "package:ggplot2"   
## [13] "package:tidyverse"  "package:kableExtra"
## [15] "package:stats"      "package:graphics"  
## [17] "package:grDevices"  "package:utils"     
## [19] "package:datasets"   "package:methods"   
## [21] "Autoloads"          "package:base"</code></pre>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Diversity(), une fonction exportée par entropart est</span></span>
<span><span class="co"># trouvée</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/entropart/man/Diversity.html">Diversity</a></span><span class="op">(</span><span class="fl">1</span>, CheckArguments <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## None 
##    1</code></pre>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Détacher et décharger entropart</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">unloadNamespace</a></span><span class="op">(</span><span class="st">"entropart"</span><span class="op">)</span></span>
<span><span class="co"># Est-il attaché ?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">isNamespaceLoaded</a></span><span class="op">(</span><span class="st">"entropart"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pile des environnements, sans entropart</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] ".GlobalEnv"         "package:R6"        
##  [3] "package:lubridate"  "package:forcats"   
##  [5] "package:stringr"    "package:dplyr"     
##  [7] "package:purrr"      "package:readr"     
##  [9] "package:tidyr"      "package:tibble"    
## [11] "package:ggplot2"    "package:tidyverse" 
## [13] "package:kableExtra" "package:stats"     
## [15] "package:graphics"   "package:grDevices" 
## [17] "package:utils"      "package:datasets"  
## [19] "package:methods"    "Autoloads"         
## [21] "package:base"</code></pre>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Diversity() est introuvable</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/entropart/man/Diversity.html">Diversity</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;simpleError in Diversity(1): could not find function "Diversity"&gt;</code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># mais peut être appelée avec son nom complet</span></span>
<span><span class="fu">entropart</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/entropart/man/Diversity.html">Diversity</a></span><span class="op">(</span><span class="fl">1</span>, CheckArguments <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## None 
##    1</code></pre>
<p></p>
<p>L’appel de <code><a href="https://rdrr.io/pkg/entropart/man/Diversity.html">entropart::Diversity()</a></code> charge le package (c’est-à-dire, exécute implicitement <code>loadNamespace("entropart")</code>) mais ne l’attache pas.</p>
<p>En pratique, il faut limiter le nombre de package attachés pour limiter le risque d’appeler une fonction non désirée, homonyme de la fonction recherchée.
Dans les cas critiques, il faut utiliser le nom complet de la fonction: <code>package::fonction()</code>.</p>
<p>Un problème fréquent concerne la fonction <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> de <strong>dplyr</strong> homonyme de celle de <strong>stats</strong>.
Le package <strong>stats</strong> est habituellement chargé avant <strong>dplyr</strong>, un package du tidyverse.
<code><a href="https://rdrr.io/r/stats/filter.html">stats::filter()</a></code> doit donc être appelée explicitement.</p>
<p>Cependant, le package <strong>dplyr</strong> ou <strong>tidyverse</strong> (qui attache tous les packages du tidyverse) peut être chargé systématiquement en créant un fichier <code>.RProfile</code> à la racine du projet contenant la commande:</p>
<p></p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Dans ce cas, <strong>dplyr</strong> est chargé <em>avant</em> <strong>stats</strong> et c’est sa fonction qui est inaccessible.</p>
</div>
</div>
<div id="mesure-du-temps-dexécution" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Mesure du temps d’exécution<a class="anchor" aria-label="anchor" href="#mesure-du-temps-dex%C3%A9cution"><i class="fas fa-link"></i></a>
</h2>
<p>Le temps d’exécution d’un code long peut être mesuré très simplement par la commande <code>system.time</code>.
Pour des temps d’exécution très courts, il est nécessaire de répéter la mesure: c’est l’objet du package <strong>microbenchmark</strong>.</p>
<div id="system.time" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> system.time<a class="anchor" aria-label="anchor" href="#system.time"><i class="fas fa-link"></i></a>
</h3>
<p>La fonction retourne le temps d’exécution du code.</p>
<p></p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Ecart absolu moyen de 1000 valeurs dans une loi uniforme,</span></span>
<span><span class="co"># répété 100 fois</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html">mad</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.012   0.000   0.013</code></pre>
<p></p>
</div>
<div id="microbenchmark" class="section level3" number="2.3.2">
<h3>
<span class="header-section-number">2.3.2</span> microbenchmark<a class="anchor" aria-label="anchor" href="#microbenchmark"><i class="fas fa-link"></i></a>
</h3>
<p>Le package <strong>microbenchmark</strong> est le plus avancé.</p>
<p>L’objectif est de comparer la vitesse du calcul du carré d’un vecteur (ou d’un nombre) en le multipliant par lui-même (<span class="math inline">\(x \times x\)</span>) ou en l’élevant à la puissance 2 (<span class="math inline">\(x^2\)</span>).</p>
<p></p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fonctions à tester</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="va">x</span></span>
<span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">f3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">2.1</span></span>
<span><span class="va">f4</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">3</span></span>
<span><span class="co"># Initialisation</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span><span class="co"># Test</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/joshuaulrich/microbenchmark/">"microbenchmark"</a></span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">f1</span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fu">f2</span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fu">f3</span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fu">f4</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Unit: microseconds
##   expr     min       lq      mean   median       uq
##  f1(X)  27.702  29.6320  40.55255  30.4290  31.7650
##  f2(X)  39.189  40.7060  51.73081  41.2585  42.3435
##  f3(X) 242.209 247.6720 259.43856 248.5685 250.2905
##  f4(X) 307.605 315.3215 333.47926 316.5395 324.1120
##       max neval
##   855.188   100
##   919.789   100
##  1162.581   100
##  1293.985   100</code></pre>
<p></p>
<p>Le tableau retourné contient les temps minimum, médian, moyen, max et les premiers et troisièmes quartiles, ainsi que le nombre de répétitions.
La valeur médiane est à comparer.
Le nombre de répétition est par défaut de 100, à moduler (argument <code>times</code>) en fonction de la complexité du calcul.</p>
<p>Le résultat du test, un objet de type <code>microbenchmark</code>, est un tableau brut des temps d’exécution.
L’analyse statistique est faite par les méthodes <code>print</code> et <code>summary</code>.
Pour choisir les colonnes à afficher, utiliser la syntaxe suivante:</p>
<p></p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##    expr   median
## 1 f1(X)  30.4290
## 2 f2(X)  41.2585
## 3 f3(X) 248.5685
## 4 f4(X) 316.5395</code></pre>
<p></p>
<p>Pour faire des calculs sur ces résultats, il faut les stocker dans une variable.
Pour empêcher l’affichage dans la console, la solution la plus simple est d’utiliser la fonction <code>capture.output</code> en affectant son résultat à une variable.</p>
<p></p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="va">mbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Le test précédent est affiché à nouveau.</p>
<p></p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##    expr   median
## 1 f1(X)  30.4290
## 2 f2(X)  41.2585
## 3 f3(X) 248.5685
## 4 f4(X) 316.5395</code></pre>
<p></p>
<p>Le temps de calcul est à peu près identique entre <span class="math inline">\(x \times x\)</span> et <span class="math inline">\(x^2\)</span>.
Le calcul de puissance est nettement plus long, surtout si la puissance n’est pas entière, parce qu’il nécessite un calcul de logarithme.
Le calcul de la puissance 2 est donc optimisé par R pour éviter l’usage du log.</p>
<p>Deux représentations graphiques sont disponibles: les violons représentent la densité de probabilité du temps d’exécution; les boîtes à moustache sont classiques.</p>
<p></p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/boxplot-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/boxplot-2.png" width="80%" style="display: block; margin: auto;"></div>
<p></p>
</div>
<div id="profilage" class="section level3" number="2.3.3">
<h3>
<span class="header-section-number">2.3.3</span> Profilage<a class="anchor" aria-label="anchor" href="#profilage"><i class="fas fa-link"></i></a>
</h3>
<p><strong>profvis</strong> est l’outil de profilage de RStudio.</p>
<p>Il permet de suivre le temps d’exécution de chaque ligne de code et la mémoire utilisée.
L’objectif est de détecter les portions de code lentes, à améliorer.</p>
<p></p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/profvis/">profvis</a></span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/profvis/man/profvis.html">profvis</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># Calculs de cosinus</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># 1/2 seconde de pause</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/profvis/man/pause.html">pause</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">htmlwidgets</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmlwidgets/man/saveWidget.html">saveWidget</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"docs/profile.html"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Le résultat est un fichier HTML contenant le rapport de profilage<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://EricMarcon.github.io/travailleR/profile.html" class="uri"&gt;https://EricMarcon.github.io/travailleR/profile.html&lt;/a&gt;&lt;/p&gt;'><sup>23</sup></a>.
On peut observer que le temps de tirage des nombres aléatoires est similaire à celui du calcul des cosinus.</p>
<p>Lire la documentation complète<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://rstudio.github.io/profvis/" class="uri"&gt;https://rstudio.github.io/profvis/&lt;/a&gt;&lt;/p&gt;'><sup>24</sup></a> sur le site de RStudio.</p>
</div>
</div>
<div id="boucles" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Boucles<a class="anchor" aria-label="anchor" href="#boucles"><i class="fas fa-link"></i></a>
</h2>
<p>Le cas le plus fréquent de code long à exécuter est celui des boucles: le même code est répété un grand nombre de fois.</p>
<div id="fonctions-vectorielles" class="section level3" number="2.4.1">
<h3>
<span class="header-section-number">2.4.1</span> Fonctions vectorielles<a class="anchor" aria-label="anchor" href="#fonctions-vectorielles"><i class="fas fa-link"></i></a>
</h3>
<p>La plupart des fonctions de R sont vectorielles: les boucles sont traitées de façon interne, extrêmement rapide.
Il faut donc raisonner en termes de vecteurs plutôt que de scalaires.</p>
<p></p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Tirage de deux vecteurs de trois nombres aléatoires entre</span></span>
<span><span class="co"># 0 et 1</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># Racine carrée des trois nombres de x1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.9427738 0.8665204 0.4586981</code></pre>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sommes respective des trois nombres de x1 et x2</span></span>
<span><span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span></span></code></pre></div>
<pre><code>## [1] 1.6262539 1.6881583 0.9063973</code></pre>
<p></p>
<p>Il faut aussi écrire des fonctions vectorielles sur leur premier argument.
La fonction <code>lnq</code> du package <strong>entropart</strong> retourne le logarithme déformé d’ordre <span class="math inline">\(q\)</span> d’un nombre <span class="math inline">\(x\)</span>.</p>
<p></p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Code de la fonction</span></span>
<span><span class="fu">entropart</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/entropart/man/lnq.html">lnq</a></span></span></code></pre></div>
<pre><code>## function (x, q) 
## {
##     if (q == 1) {
##         return(log(x))
##     }
##     else {
##         Log &lt;- (x^(1 - q) - 1)/(1 - q)
##         Log[x &lt; 0] &lt;- NA
##         return(Log)
##     }
## }
## &lt;bytecode: 0x7fe0a909e518&gt;
## &lt;environment: namespace:entropart&gt;</code></pre>
<p></p>
<p>Pour qu’une fonction soit vectorielle, chaque ligne de son code doit permettre que le premier argument soit traité comme un vecteur.
Ici: <code>log(x)</code> et <code>x^</code> sont une fonction et un opérateur vectoriels et la condition <code>[x &lt; 0]</code> retourne aussi un vecteur.</p>
</div>
<div id="lapply" class="section level3" number="2.4.2">
<h3>
<span class="header-section-number">2.4.2</span> lapply<a class="anchor" aria-label="anchor" href="#lapply"><i class="fas fa-link"></i></a>
</h3>
<p>Les codes qui ne peuvent pas être écrits comme une fonction vectorielle nécessitent des boucles.</p>
<p><code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> applique une fonction à chaque élément d’une liste.
Elle est déclinée sous plusieurs versions:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> renvoie une liste (économise le temps de leur réorganisation dans un tableau);</li>
<li>
<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> renvoie un dataframe en rassemblant les listes par <code><a href="https://rdrr.io/r/base/lapply.html">simplify2array()</a></code>;</li>
<li>
<code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> est presque identique mais demande que le type de données du résultat soit fourni.</li>
</ul>
<p></p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Tirage de 1000 valeurs dans une loi uniforme</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co"># La racine carrée peut être calculée pour le vecteur ou</span></span>
<span><span class="co"># chaque valeur</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">x1</span>,</span>
<span>    FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span>, FUN.VALUE <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                                    expr   median
## 1                              sqrt(x1)   7.2395
## 2                lapply(x1, FUN = sqrt) 268.7030
## 3                sapply(x1, FUN = sqrt) 310.4755
## 4 vapply(x1, FUN = sqrt, FUN.VALUE = 0) 279.7850</code></pre>
<p></p>
<p><code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> est beaucoup plus lent qu’une fonction vectorielle.
<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> nécessite plus de temps pour <code><a href="https://rdrr.io/r/base/lapply.html">simplify2array()</a></code>, qui doit détecter comment rassembler les résultats.
Enfin, <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> économise le temps de détermination du type de données du résultat et permet d’accélérer le calcul avec peu d’efforts.</p>
</div>
<div id="boucles-for" class="section level3" number="2.4.3">
<h3>
<span class="header-section-number">2.4.3</span> Boucles for<a class="anchor" aria-label="anchor" href="#boucles-for"><i class="fas fa-link"></i></a>
</h3>
<p>Les boucles sont gérées par la fonction <code>for</code>.
Elles ont la réputation d’être lentes dans R parce que le code à l’intérieur de la boucle doit être interprété à chaque exécution.
Ce n’est plus le cas depuis la version 3.5 de R: les boucles sont compilées systématiquement avant leur exécution.
Le comportement du compilateur “juste à temps” est défini par la fonction <code>enableJIT</code>.
Le niveau par défaut est 3: les fonctions sont toutes compilées, et les boucles dans le code aussi.</p>
<p>Pour évaluer le gain de performance, le code suivant supprime toute compilation automatique, et compare la même boucle compilée ou non.</p>
<p></p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"compiler"</span><span class="op">)</span></span>
<span><span class="co"># Pas de compilation automatique</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/compiler/compile.html">enableJIT</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Boucle pour calculer la racine carrée d'un vecteur</span></span>
<span><span class="va">Boucle</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Initialisation du vecteur de résultat, indispensable</span></span>
<span>    <span class="va">Racine</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"numeric"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># Boucle</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">Racine</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">Racine</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Version compilée</span></span>
<span><span class="va">Boucle2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/compiler/compile.html">cmpfun</a></span><span class="op">(</span><span class="va">Boucle</span><span class="op">)</span></span>
<span><span class="co"># Comparaison</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">Boucle</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>, <span class="fu">Boucle2</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">mbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>##          expr   median
## 1  Boucle(x1) 621.6985
## 2 Boucle2(x1)  70.8855</code></pre>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compilation automatique par défaut depuis la version 3.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/compiler/compile.html">enableJIT</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p></p>
<p>Le gain est considérable: de 1 à <code>9</code>.</p>
<p>Les boucles for sont maintenant nettement plus rapides que <code>vapply</code>.</p>
<p></p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu">Boucle</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                        expr   median
## 1 vapply(x1, FUN = sqrt, 0) 280.0750
## 2                Boucle(x1)  70.2115</code></pre>
<p></p>
<p>Attention, le test de performance peut être trompeur:</p>
<p></p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Préparation du vecteur de résultat</span></span>
<span><span class="va">Racine</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"numeric"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Test</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span>, <span class="fl">0</span><span class="op">)</span>, </span>
<span>                     <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span> </span>
<span>                       <span class="va">Racine</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                                               expr   median
## 1                        vapply(x1, FUN = sqrt, 0)  281.413
## 2 for (i in 1:length(x1)) Racine[i] &lt;- sqrt(x1[i]) 2210.162</code></pre>
<p></p>
<p>Dans ce code, la boucle for n’est pas compilée donc elle est beaucoup plus lente que dans le cadre normal de son utilisation (dans une fonction ou au niveau supérieur du code).</p>
<p>Les boucles longues permettent un suivi de leur progression par une barre de texte, ce qui est un autre avantage.
La fonction suivante exécute des pauses d’un dixième de seconde pendant le temps passé en paramètre (en secondes).</p>
<p></p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BoucleSuivie</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">duree</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Barre de progression</span></span>
<span>    <span class="va">pgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/txtProgressBar.html">txtProgressBar</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="va">duree</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="co"># Boucle</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">duree</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Pause d'un dixième de seconde</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span></span>
<span>        <span class="co"># Suivi de la progression</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/utils/txtProgressBar.html">setTxtProgressBar</a></span><span class="op">(</span><span class="va">pgb</span>, <span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">BoucleSuivie</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## ============================================================</code></pre>
<p></p>
</div>
<div id="replicate" class="section level3" number="2.4.4">
<h3>
<span class="header-section-number">2.4.4</span> replicate<a class="anchor" aria-label="anchor" href="#replicate"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/lapply.html">replicate()</a></code> répète une instruction.</p>
<p></p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.9453453 0.5262818 0.7233425</code></pre>
<p></p>
<p>Ce code est équivalent à <code>runif(3)</code>, avec des performances similaires à celles de <code>vapply</code>: de 50 à 100 fois plus lent qu’une fonction vectorielle.</p>
<p></p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                        expr   median
## 1 replicate(1000, runif(1)) 1944.555
## 2               runif(1000)   14.664</code></pre>
<p></p>
</div>
<div id="vectorize" class="section level3" number="2.4.5">
<h3>
<span class="header-section-number">2.4.5</span> Vectorize<a class="anchor" aria-label="anchor" href="#vectorize"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize()</a></code> rend vectorielle une fonction qui ne l’est pas, par des boucles.
Ecrire plutôt les boucles.</p>
</div>
<div id="statistiques-marginales" class="section level3" number="2.4.6">
<h3>
<span class="header-section-number">2.4.6</span> Statistiques marginales<a class="anchor" aria-label="anchor" href="#statistiques-marginales"><i class="fas fa-link"></i></a>
</h3>
<p><code>apply</code> applique une fonction aux lignes ou colonnes d’un objet en deux dimensions.</p>
<p><code>colSums</code> et ses semblables (<code>rowSums</code>, <code>colMeans</code>, <code>rowMeans</code>) sont optimisées.</p>
<p></p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Somme des colonnes numériques du jeu de données diamonds de ggplot2</span></span>
<span><span class="co"># Boucle identique à l'action de apply(, 2, )</span></span>
<span><span class="va">BoucleSomme</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Table</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Somme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"numeric"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Table</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Table</span><span class="op">)</span><span class="op">)</span> <span class="va">Somme</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Table</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">Somme</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">BoucleSomme</span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                              expr   median
## 1   BoucleSomme(diamonds[-(2:4)]) 2.759207
## 2 apply(diamonds[-(2:4)], 2, sum) 6.926465
## 3       colSums(diamonds[-(2:4)]) 1.944116</code></pre>
<p></p>
<p><code>apply</code> clarifie le code mais est plus lent que la boucle, qui est à peine plus lente que <code>colSums</code>.</p>
</div>
</div>
<div id="sec:cpp" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Code C++<a class="anchor" aria-label="anchor" href="#sec:cpp"><i class="fas fa-link"></i></a>
</h2>
<p>L’intégration de code C++ dans R est largement simplifiée par le package <strong>Rcpp</strong> mais reste difficile à déboguer et donc à réserver à du code très simple (pour éviter toute erreur) et répété un grand nombre de fois (pour mériter l’effort).
La préparation des données et leur vérification doivent être exécutées sous R, de même que le traitement et la présentation des résultats.</p>
<p>L’utilisation habituelle est l’inclusion de code C++ dans un package, mais l’utilisation hors package est possible:</p>
<ul>
<li>Le code C++ peut être inclus dans un document C++ (fichier avec l’extension <code>.cpp</code>): il est compilé par la commande <code>sourceCpp()</code> qui crée les fonctions R permettant d’appeler le code C++.</li>
<li>Dans un document RMarkdown, des bouts de code Rcpp peuvent être créés pour y insérer le code C++: ils sont compilés et interfacés pour R au moment du tricotage.</li>
</ul>
<p>L’exemple suivant montre comment créer une fonction C++ pour calculer le double d’un vecteur numérique.</p>
<p></p>
<div class="sourceCode" id="cb136"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb136-1"><a href="chap-utiliseR.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb136-2"><a href="chap-utiliseR.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb136-3"><a href="chap-utiliseR.html#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="chap-utiliseR.html#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb136-5"><a href="chap-utiliseR.html#cb136-5" aria-hidden="true" tabindex="-1"></a>NumericVector timesTwo<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb136-6"><a href="chap-utiliseR.html#cb136-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb136-7"><a href="chap-utiliseR.html#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Une fonction R du même nom que la fonction C++ est maintenant disponible.</p>
<p></p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">timesTwo</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1]  2  4  6  8 10</code></pre>
<p></p>
<p>Les performances sont deux ordres de grandeur plus rapides que le code R (voir l’étude de cas, section <a href="chap-utiliseR.html#sec:cas">2.7</a>).</p>
</div>
<div id="paralléliser-r" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Paralléliser R<a class="anchor" aria-label="anchor" href="#parall%C3%A9liser-r"><i class="fas fa-link"></i></a>
</h2>
<p>Lorsque des calculs longs peuvent être découpés en tâches indépendantes, l’exécution simultanée (<em>parallèle</em>) de ces tâches permet de réduire le temps de calcul total à celui de la tâche la plus longue, auquel s’ajoute le coût de la mise en place de la parallélisation (création des tâches, récupération des résultats…).</p>
<p>Lire l’excellente introduction de Josh Errickson<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html" class="uri"&gt;http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html&lt;/a&gt;&lt;/p&gt;'><sup>25</sup></a> qui détaille les enjeux et les contraintes de la parallélisation.</p>
<p>Deux mécanismes sont disponibles pour l’exécution de code en parallèle:</p>
<ul>
<li>
<em>fork</em>: le processus en cours d’exécution est dupliqué sur plusieurs cœurs du processeur de l’ordinateur de calcul.
C’est la méthode la plus simple mais elle ne fonctionne pas sous Windows (limite du système d’exploitation).</li>
<li>
<em>socket</em>: un cluster est constitué, soit physiquement (un ensemble d’ordinateurs exécutant R est nécessaire) soit logiquement (une instance de R sur chaque cœur de l’ordinateur utilisé).
Les membres du cluster communiquent par le réseau (le réseau interne de l’ordinateur utilisé pour un cluster logique).</li>
</ul>
<p>Différents packages de R permettent de mettre en œuvre ces mécanismes.</p>
<div id="mclapply-fork" class="section level3" number="2.6.1">
<h3>
<span class="header-section-number">2.6.1</span> mclapply (fork)<a class="anchor" aria-label="anchor" href="#mclapply-fork"><i class="fas fa-link"></i></a>
</h3>
<p>La fonction <code>mclapply</code> du package <strong>parallel</strong> a la même syntaxe que <code>lapply</code> mais parallélise l’exécution des boucles.
Sous Windows, elle n’a aucun effet puisque le système ne permet pas les <em>fork</em>: elle appelle simplement <code>lapply</code>.
Cependant, un contournement existe pour émuler <code>mclapply</code> sous Windows en appelant <code>parLapply</code>, qui utilise un cluster.</p>
<p></p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##</span></span>
<span><span class="co">## mclapply.hack.R</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Nathan VanHoudnos</span></span>
<span><span class="co">## nathanvan AT northwestern FULL STOP edu</span></span>
<span><span class="co">## July 14, 2014</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## A script to implement a hackish version of </span></span>
<span><span class="co">## parallel:mclapply() on Windows machines.</span></span>
<span><span class="co">## On Linux or Mac, the script has no effect</span></span>
<span><span class="co">## beyond loading the parallel library. </span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>    </span></code></pre></div>
<pre><code>## Loading required package: parallel</code></pre>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Define the hack</span></span>
<span><span class="co"># mc.cores argument added: Eric Marcon</span></span>
<span><span class="va">mclapply.hack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">mc.cores</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Create a cluster</span></span>
<span>  <span class="va">size.of.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">size.of.list</span>, <span class="va">mc.cores</span><span class="op">)</span> <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Find out the names of the loaded packages </span></span>
<span>  <span class="va">loaded.package.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="co">## Base packages</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">basePkgs</span>,</span>
<span>    <span class="co">## Additional packages</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">otherPkgs</span> <span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co">## Copy over all of the objects within scope to</span></span>
<span>    <span class="co">## all clusters. </span></span>
<span>    <span class="va">this.env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">while</span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span> <span class="va">this.env</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>all.names<span class="op">=</span><span class="cn">TRUE</span>, env<span class="op">=</span><span class="va">this.env</span><span class="op">)</span>,</span>
<span>                    envir<span class="op">=</span><span class="va">this.env</span><span class="op">)</span></span>
<span>      <span class="va">this.env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">parent.env</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>all.names<span class="op">=</span><span class="cn">TRUE</span>, env<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  envir<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## Load the libraries on all the clusters</span></span>
<span>    <span class="co">## N.B. length(cl) returns the number of clusters</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parLapply</a></span><span class="op">(</span> <span class="va">cl</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">xx</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">loaded.package.names</span>, <span class="kw">function</span><span class="op">(</span><span class="va">yy</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">yy</span> , character.only<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## Run the lapply in parallel </span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parLapply</a></span><span class="op">(</span> <span class="va">cl</span>, <span class="va">...</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">}</span>, finally <span class="op">=</span> <span class="op">{</span>        </span>
<span>    <span class="co">## Stop the cluster</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Warn the user if they are using Windows</span></span>
<span><span class="kw">if</span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">'sysname'</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">'Windows'</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"\n"</span>, </span>
<span>    <span class="st">"   *** Microsoft Windows detected ***\n"</span>,</span>
<span>    <span class="st">"   \n"</span>,</span>
<span>    <span class="st">"   For technical reasons, the MS Windows version of mclapply()\n"</span>,</span>
<span>    <span class="st">"   is implemented as a serial function instead of a parallel\n"</span>,</span>
<span>    <span class="st">"   function."</span>,</span>
<span>    <span class="st">"   \n\n"</span>,</span>
<span>    <span class="st">"   As a quick hack, we replace this serial version of mclapply()\n"</span>,</span>
<span>    <span class="st">"   with a wrapper to parLapply() for this R session. Please see\n\n"</span>,</span>
<span>    <span class="st">"     http://www.stat.cmu.edu/~nmv/2014/07/14/</span></span>
<span><span class="st">    implementing-mclapply-on-windows \n\n"</span>,</span>
<span>    <span class="st">"   for details.\n\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## If the OS is Windows, set mclapply to the</span></span>
<span><span class="co">## the hackish version. Otherwise, leave the</span></span>
<span><span class="co">## definition alone. </span></span>
<span><span class="va">mclapply</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">'sysname'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                    Windows <span class="op">=</span> <span class="op">{</span><span class="va">mclapply.hack</span><span class="op">}</span>, </span>
<span>                    Linux   <span class="op">=</span> <span class="op">{</span><span class="va">mclapply</span><span class="op">}</span>,</span>
<span>                    Darwin  <span class="op">=</span> <span class="op">{</span><span class="va">mclapply</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## end mclapply.hack.R</span></span></code></pre></div>
<p></p>
<p>Le code suivant teste la parallélisation d’une fonction qui renvoie son argument inchangé après une pause d’un quart de seconde.
Ce document est tricoté avec <code>4</code> cœurs, qui sont tous utilisés sauf un pour ne pas saturer le système.</p>
<p></p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">time</span> <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Laisser un coeur libre pour le système</span></span>
<span><span class="va">nbCoeurs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="co"># Série : temps théorique = nbCoeurs/4 secondes</span></span>
<span><span class="op">(</span><span class="va">tserie</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nbCoeurs</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.003   0.000   0.902</code></pre>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallèle : temps théorique = 1/4 seconde</span></span>
<span><span class="op">(</span><span class="va">tparallele</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nbCoeurs</span>, <span class="va">f</span>, mc.cores <span class="op">=</span> <span class="va">nbCoeurs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.002   0.004   0.267</code></pre>
<p></p>
<p>La mise en place de la parallélisation a un coût d’environ <code>0.017</code> secondes ici.
Le temps d’exécution est bien plus long en parallèle sous Windows parce que la mise en place du cluster prend bien plus de temps que la parallélisation n’en fait gagner.
La parallélisation est intéressante pour des tâches plus longues, comme une pause d’un seconde.</p>
<p></p>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Série</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nbCoeurs</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.000   0.000   3.246</code></pre>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallèle</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nbCoeurs</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="va">nbCoeurs</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.001   0.004   1.047</code></pre>
<p></p>
<p>Le temps additionnel nécessaire pour l’exécution parallèle du nouveau code est relativement plus faible: les coûts deviennent inférieurs à l’économie quand le temps de chaque tâche s’allonge.</p>
<p>Si le nombre de tâches parallèles dépasse le nombre de cœurs utilisés, les performances s’effondrent parce que la tâche supplémentaire doit être exécutée après les premières.</p>
<p></p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nbCoeurs</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="va">nbCoeurs</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.001   0.003   1.043</code></pre>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">nbCoeurs</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="va">nbCoeurs</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.004   0.008   2.276</code></pre>
<p></p>
<p>Le temps reste ensuite stable jusqu’au double du nombre de cœurs.
La figure <a href="chap-utiliseR.html#fig:r-parallele">2.2</a> montre l’évolution du temps de calcul en fonction du nombre de tâches.</p>

<p></p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Taches</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">nbCoeurs</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">Temps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">Taches</span>, <span class="kw">function</span><span class="op">(</span><span class="va">nbTaches</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nbTaches</span>, <span class="va">f</span>, time<span class="op">=</span><span class="fl">1</span>, mc.cores<span class="op">=</span><span class="va">nbCoeurs</span><span class="op">)</span><span class="op">)</span></span>
<span>              <span class="op">}</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">Taches</span>, Temps<span class="op">=</span><span class="va">Temps</span><span class="op">[</span><span class="st">"elapsed"</span>, <span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ggplot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Taches</span>, y <span class="op">=</span> <span class="va">Temps</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">nbCoeurs</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">nbCoeurs</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:r-parallele"></span>
<img src="travailleR_files/figure-html/r-parallele-1.png" alt="Temps d’exécution en parallèle de tâches nécessitant une seconde (chaque tâche est une pause d’une seconde). Le nombre de tâches varie de 1 à deux fois le nombre de cœurs utilisés (égal à 3) plus une." width="80%"><p class="caption">
Figure 2.2: Temps d’exécution en parallèle de tâches nécessitant une seconde (chaque tâche est une pause d’une seconde). Le nombre de tâches varie de 1 à deux fois le nombre de cœurs utilisés (égal à <code>3</code>) plus une.
</p>
</div>
<p></p>
<p>La forme théorique de cette courbe est la suivante:</p>
<ul>
<li>pour une tâche, le temps est égal à une seconde plus le temps de mise en place de la parallélisation;</li>
<li>le temps devrait rester stable jusqu’au nombre de cœurs utilisés;</li>
<li>quand les cœurs sont tous utilisés (pointillés rouges), le temps devrait augmenter d’une seconde puis rester stable jusqu’à la limite suivante.</li>
</ul>
<p>En pratique, le temps de calcul est déterminé par d’autres facteurs difficilement prévisibles.
La bonne pratique est d’adapter le nombre de tâches au nombre de cœurs sous peine de perte de performance.</p>
</div>
<div id="parlapply-socket" class="section level3" number="2.6.2">
<h3>
<span class="header-section-number">2.6.2</span> parLapply (socket)<a class="anchor" aria-label="anchor" href="#parlapply-socket"><i class="fas fa-link"></i></a>
</h3>
<p><code>parLapply</code> nécessite de créer un cluster, exporter les variables utiles sur chaque noeud, charger les packages nécessaires sur chaque noeud, exécuter le code et enfin arrêter le cluster.
Le code de chaque étape se trouve dans la fonction <code>mclapply.hack</code> ci-dessus.</p>
<p>Pour un usage courant, <code>mclapply</code> est plus rapide, sauf sous Windows, et plus simple (y compris sous Windows grâce au contournement ci-dessus.)</p>
</div>
<div id="foreach" class="section level3" number="2.6.3">
<h3>
<span class="header-section-number">2.6.3</span> foreach<a class="anchor" aria-label="anchor" href="#foreach"><i class="fas fa-link"></i></a>
</h3>
<div id="fonctionnement" class="section level4" number="2.6.3.1">
<h4>
<span class="header-section-number">2.6.3.1</span> Fonctionnement<a class="anchor" aria-label="anchor" href="#fonctionnement"><i class="fas fa-link"></i></a>
</h4>
<p>Le package <strong>foreach</strong> permet un usage avancé de la parallélisation.
Lire ses vignettes.</p>
<p></p>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Manuel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"foreach"</span>, <span class="st">"foreach"</span><span class="op">)</span></span>
<span><span class="co"># Boucles imbriquées</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"nested"</span>, <span class="st">"foreach"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Indépendamment de la parallélisation, <strong>foreach</strong> redéfinit les boucles <em>for</em>.</p>
<p></p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># devient</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/RevolutionAnalytics/foreach">"foreach"</a></span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Attaching package: 'foreach'</code></pre>
<pre><code>## The following objects are masked from 'package:purrr':
## 
##     accumulate, when</code></pre>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 2
## 
## [[3]]
## [1] 3</code></pre>
<p></p>
<p>La fonction <code>foreach</code> retourne une liste contenant les résultats de chaque boucle.
Les éléments de la liste peuvent être combinés par une fonction quelconque, comme <code>c</code>.</p>
<p></p>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 1 2 3</code></pre>
<p></p>
<p>La fonction <code>foreach</code> est capable d’utiliser des itérateurs, c’est-à-dire des fonctions qui ne passent à la boucle que les données dont elle a besoin sans charger les autres en mémoire.
Ici, l’itérateur <code>icount</code> passe les valeurs 1, 2 et 3 individuellement, sans charger le vecteur 1:3 en mémoire.</p>
<p></p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/RevolutionAnalytics/iterators">"iterators"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 1 2 3</code></pre>
<p></p>
<p>Elle est donc très utile quand chaque objet de la boucle utilise une grande quantité de mémoire.</p>
</div>
<div id="parallélisation" class="section level4" number="2.6.3.2">
<h4>
<span class="header-section-number">2.6.3.2</span> Parallélisation<a class="anchor" aria-label="anchor" href="#parall%C3%A9lisation"><i class="fas fa-link"></i></a>
</h4>
<p>Remplacer l’opérateur <code>%do%</code> par <code>%dopar%</code> parallélise les boucles, à condition qu’un adaptateur, c’est-à-dire un package intermédiaire entre <code>foreach</code> et un package chargé de l’implémentation de la parallélisation, soit chargé.
<strong>doParallel</strong> est un adaptateur pour utiliser le package <strong>parallel</strong> livré avec R.</p>
<p></p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="va">nbCoeurs</span><span class="op">)</span></span>
<span><span class="co"># Série</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="va">nbCoeurs</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span></span>
<span>    <span class="op">{</span></span>
<span>        <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.003   0.000   0.943</code></pre>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallèle</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="va">nbCoeurs</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span></span>
<span>    <span class="op">{</span></span>
<span>        <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.009   0.016   0.273</code></pre>
<p></p>
<p>Le coût fixe de la parallélisation est faible.</p>
</div>
</div>
</div>
<div id="sec:cas" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Etude de cas<a class="anchor" aria-label="anchor" href="#sec:cas"><i class="fas fa-link"></i></a>
</h2>
<p>Cette étude de cas permet de tester les différentes techniques vues plus haut pour résoudre un problème concret.
L’objectif est de calculer la distance moyenne entre deux points d’un semis aléatoire de 1000 points dans une fenêtre carrée de côté 1.</p>
<p>Son espérance est calculable<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://mindyourdecisions.com/blog/2016/07/03/distance-between-two-random-points-in-a-square-sunday-puzzle/" class="uri"&gt;https://mindyourdecisions.com/blog/2016/07/03/distance-between-two-random-points-in-a-square-sunday-puzzle/&lt;/a&gt;&lt;/p&gt;'><sup>26</sup></a>.
Elle est égale à <span class="math inline">\(\frac{2+\sqrt{2}+5\ln{(1+\sqrt{2})}}{15} \approx 0,5214\)</span>.</p>
<div id="création-des-données" class="section level3" number="2.7.1">
<h3>
<span class="header-section-number">2.7.1</span> Création des données<a class="anchor" aria-label="anchor" href="#cr%C3%A9ation-des-donn%C3%A9es"><i class="fas fa-link"></i></a>
</h3>
<p>Le semis de points est créé avec le package <strong>spatstat</strong>.</p>
<p></p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NbPoints</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://spatstat.org/">"spatstat"</a></span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">NbPoints</span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="spatstat" class="section level3" number="2.7.2">
<h3>
<span class="header-section-number">2.7.2</span> Spatstat<a class="anchor" aria-label="anchor" href="#spatstat"><i class="fas fa-link"></i></a>
</h3>
<p>La fonction <code><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist()</a></code> de <strong>spatstat</strong> retourne la matrice des distances entre les points.
La distance moyenne est calculée en divisant la somme par le nombre de paires de points distincts.</p>
<p></p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span></span>
<span>    <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># suppressMessages pour éliminer les messages superflus</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/pairdist-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>La fonction est rapide parce qu’elle est codée en langage C dans le package <strong>spatstat</strong> pour le cœur de ses calculs.</p>
</div>
<div id="apply" class="section level3" number="2.7.3">
<h3>
<span class="header-section-number">2.7.3</span> apply<a class="anchor" aria-label="anchor" href="#apply"><i class="fas fa-link"></i></a>
</h3>
<p>La distance peut être calculée par deux <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> imbriqués.</p>
<p></p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply1</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.926   0.013   3.944</code></pre>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>Un peu de temps peut être gagnée en remplaçant <code>sapply</code> par <code>vapply</code>: le format des résultats n’a pas à être déterminé par la fonction.
Le gain est négligeable sur un long calcul comme celui-ci mais important pour des calculs courts.</p>
<p></p>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>        <span class="fl">0</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">+</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply2</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.908   0.005   3.914</code></pre>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p>
Le format de sortie n’est pas toujours évident à écrire:</p>
<ul>
<li>il doit respecter la taille des données: un vecteur de taille 1000 pour la boucle externe, un scalaire pour la boucle interne.</li>
<li>il doit respecter leur type: <code>0</code> pour un entier, <code>0.0</code> pour un réel. Dans la boucle externe, l’ajout de <code>0.0</code> au vecteur d’entiers le transforme en vecteur de réels.</li>
</ul>
<p>Une amélioration plus significative consiste à ne calculer les racines carrées qu’à la fin de la boucle, pour profiter de la vectorisation de la fonction.</p>
<p></p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>,</span>
<span>        <span class="fl">0</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">+</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply3</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.880   0.006   3.887</code></pre>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>Les calculs sont effectués deux fois (distance entre les points <span class="math inline">\(i\)</span> et <span class="math inline">\(j\)</span>, mais aussi entre les points <span class="math inline">\(j\)</span> et <span class="math inline">\(i\)</span>): un test sur les indices permet de diviser presque le temps par 2 (pas tout à fait parce que les boucles sans calcul, qui retournent <span class="math inline">\(0\)</span>, prennent du temps).</p>
<p></p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply4</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">j</span> <span class="op">&gt;</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>                <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>                <span class="fl">0</span></span>
<span>            <span class="op">}</span></span>
<span>        <span class="op">}</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">}</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">+</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply4</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.354   0.003   2.356</code></pre>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>En parallèle, le temps de calcul n’est pas amélioré sous Windows parce que les tâches individuelles sont trop courtes.
Sous MacOS ou Linux, le calcul est accéléré.</p>
<p></p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply5</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">NbPoints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">j</span> <span class="op">&gt;</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>                <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>                <span class="fl">0</span></span>
<span>            <span class="op">}</span></span>
<span>        <span class="op">}</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">simplify2array</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span></span>
<span>        <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply5</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.461   0.250   1.389</code></pre>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
</div>
<div id="boucle-for" class="section level3" number="2.7.4">
<h3>
<span class="header-section-number">2.7.4</span> boucle for<a class="anchor" aria-label="anchor" href="#boucle-for"><i class="fas fa-link"></i></a>
</h3>
<p>Une boucle for est plus rapide et consomme moins de mémoire parce qu’elle ne stocke pas la matrice de distances.</p>
<p></p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distance</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">ffor</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">NbPoints</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">distance</span> <span class="op">&lt;-</span> <span class="va">distance</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span></span>
<span>                <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">distance</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Temps de calcul, mémorisé</span></span>
<span><span class="op">(</span><span class="va">for_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">ffor</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.381   0.004   1.384</code></pre>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>C’est la façon la plus simple et efficace d’écrire ce code sans parallélisation et en se limitant au langage de R.</p>
</div>
<div id="boucle-foreach" class="section level3" number="2.7.5">
<h3>
<span class="header-section-number">2.7.5</span> boucle foreach<a class="anchor" aria-label="anchor" href="#boucle-foreach"><i class="fas fa-link"></i></a>
</h3>
<p>Deux boucles foreach imbriquées sont nécessaires ici: elles sont extrêmement lentes en comparaison d’une boucle simple.
Le test est lancé ici avec 10 fois moins de points, donc 100 fois moins de distances à calculer.</p>
<p></p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NbPointsReduit</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">NbPointsReduit</span><span class="op">)</span></span>
<span><span class="va">fforeach1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">NbPointsReduit</span>, .combine <span class="op">=</span> <span class="st">"cbind"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%:%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>j <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">NbPointsReduit</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">j</span> <span class="op">&gt;</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="fl">0</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">NbPointsReduit</span><span class="op">/</span><span class="op">(</span><span class="va">NbPointsReduit</span> <span class="op">-</span></span>
<span>        <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fforeach1</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.615   0.012   1.628</code></pre>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5181951</code></pre>
<p></p>
<p>Les boucles foreach imbriquées sont à réserver à des tâches très longues (plusieurs secondes au moins) pour amortir les coûts fixes de leur mise en place.</p>
<p>La parallélisation est efficace dans le code ci-dessous, notamment parce qu’elle permet d’éviter les boucles foreach imbriquées.
En revanche, les distances sont calculées deux fois.
La performance reste très inférieure à celle d’une simple boucle for (rappel: 100 fois moins de distances sont calculées).</p>
<p></p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fforeach3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="va">NbPointsReduit</span><span class="op">)</span>, </span>
<span>            .combine<span class="op">=</span><span class="st">'+'</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>      <span class="va">distance</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Y</span><span class="op">$</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">distance</span> <span class="op">&lt;-</span> <span class="va">distance</span> <span class="op">+</span> </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">-</span><span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">-</span><span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">distance</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">distances</span><span class="op">/</span><span class="va">NbPointsReduit</span><span class="op">/</span><span class="op">(</span><span class="va">NbPointsReduit</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fforeach3</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.081   0.038   0.065</code></pre>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5181951</code></pre>
<p></p>
<p><strong>foreach</strong> dispose d’adaptateurs optimisés permettant d’utiliser des clusters physiques par exemple.
Son intérêt est limité avec le package <strong>parallel</strong>.</p>
</div>
<div id="rcpp" class="section level3" number="2.7.6">
<h3>
<span class="header-section-number">2.7.6</span> RCpp<a class="anchor" aria-label="anchor" href="#rcpp"><i class="fas fa-link"></i></a>
</h3>
<p>La fonction C++ permettant de calculer les distances est la suivante.</p>
<p></p>
<div class="sourceCode" id="cb205"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb205-1"><a href="chap-utiliseR.html#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb205-2"><a href="chap-utiliseR.html#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb205-3"><a href="chap-utiliseR.html#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="chap-utiliseR.html#cb205-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb205-5"><a href="chap-utiliseR.html#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> MeanDistance<span class="op">(</span>NumericVector x<span class="op">,</span> NumericVector y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb205-6"><a href="chap-utiliseR.html#cb205-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> distance<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb205-7"><a href="chap-utiliseR.html#cb205-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dx<span class="op">,</span> dy<span class="op">;</span></span>
<span id="cb205-8"><a href="chap-utiliseR.html#cb205-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="op">(</span>x<span class="op">.</span>length<span class="op">()-</span><span class="dv">1</span><span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb205-9"><a href="chap-utiliseR.html#cb205-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> x<span class="op">.</span>length<span class="op">();</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb205-10"><a href="chap-utiliseR.html#cb205-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calcul de la distance</span></span>
<span id="cb205-11"><a href="chap-utiliseR.html#cb205-11" aria-hidden="true" tabindex="-1"></a>        dx <span class="op">=</span> x<span class="op">[</span>i<span class="op">]-</span>x<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb205-12"><a href="chap-utiliseR.html#cb205-12" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">=</span> y<span class="op">[</span>i<span class="op">]-</span>y<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb205-13"><a href="chap-utiliseR.html#cb205-13" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">+=</span> sqrt<span class="op">(</span>dx<span class="op">*</span>dx <span class="op">+</span> dy<span class="op">*</span>dy<span class="op">);</span></span>
<span id="cb205-14"><a href="chap-utiliseR.html#cb205-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb205-15"><a href="chap-utiliseR.html#cb205-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb205-16"><a href="chap-utiliseR.html#cb205-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> distance<span class="op">/(</span><span class="dt">double</span><span class="op">)(</span>x<span class="op">.</span>length<span class="op">()/</span><span class="dv">2</span><span class="op">*(</span>x<span class="op">.</span>length<span class="op">()-</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb205-17"><a href="chap-utiliseR.html#cb205-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Elle est appelée dans R très simplement.
Le temps d’exécution est très court.</p>
<p></p>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">MeanDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># suppressMessages pour éliminer les messages superflus</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/RCpp-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
</div>
<div id="rcppparallel" class="section level3" number="2.7.7">
<h3>
<span class="header-section-number">2.7.7</span> RcppParallel<a class="anchor" aria-label="anchor" href="#rcppparallel"><i class="fas fa-link"></i></a>
</h3>
<p><strong>RcppParallel</strong> permet d’interfacer du code C++ parallélisé, au prix d’une syntaxe plus complexe qu’avec <strong>RCpp</strong>.
Une documentation est disponible<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="http://rcppcore.github.io/RcppParallel/" class="uri"&gt;http://rcppcore.github.io/RcppParallel/&lt;/a&gt;&lt;/p&gt;'><sup>27</sup></a>.</p>
<p>La fonction C++ exportée dans R ne réalise pas les calculs mais organise seulement l’exécution en parallèle d’une autre fonction, non exportée, de type <code>Worker</code>.</p>
<p>Deux fonctions (C++) de parallélisation sont disponibles pour deux types de tâches:</p>
<ul>
<li>
<code>parallelReduce</code> pour l’accumulation d’une valeur, utilisée ici pour additionner les distances.</li>
<li>
<code>parallelFor</code> pour remplir une matrice de résultats.</li>
</ul>
<p>La syntaxe du <code>Worker</code> est un peu laborieuse mais assez simple à adapter: les constructeurs initialisent les variables C à partir des valeurs transmises par R et déclarent la parallélisation.</p>
<p></p>
<div class="sourceCode" id="cb209"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb209-1"><a href="chap-utiliseR.html#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppParallel)]]</span></span>
<span id="cb209-2"><a href="chap-utiliseR.html#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb209-3"><a href="chap-utiliseR.html#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppParallel.h&gt;</span></span>
<span id="cb209-4"><a href="chap-utiliseR.html#cb209-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb209-5"><a href="chap-utiliseR.html#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> RcppParallel<span class="op">;</span></span>
<span id="cb209-6"><a href="chap-utiliseR.html#cb209-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-7"><a href="chap-utiliseR.html#cb209-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Fonction de travail, non exportée</span></span>
<span id="cb209-8"><a href="chap-utiliseR.html#cb209-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> TotalDistanceWrkr <span class="op">:</span> <span class="kw">public</span> Worker</span>
<span id="cb209-9"><a href="chap-utiliseR.html#cb209-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb209-10"><a href="chap-utiliseR.html#cb209-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Vecteurs source</span></span>
<span id="cb209-11"><a href="chap-utiliseR.html#cb209-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> RVector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Rx<span class="op">;</span></span>
<span id="cb209-12"><a href="chap-utiliseR.html#cb209-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> RVector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Ry<span class="op">;</span></span>
<span id="cb209-13"><a href="chap-utiliseR.html#cb209-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-14"><a href="chap-utiliseR.html#cb209-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Valeur accumulée</span></span>
<span id="cb209-15"><a href="chap-utiliseR.html#cb209-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> distance<span class="op">;</span></span>
<span id="cb209-16"><a href="chap-utiliseR.html#cb209-16" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb209-17"><a href="chap-utiliseR.html#cb209-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Constructeurs</span></span>
<span id="cb209-18"><a href="chap-utiliseR.html#cb209-18" aria-hidden="true" tabindex="-1"></a>  TotalDistanceWrkr<span class="op">(</span><span class="at">const</span> NumericVector x<span class="op">,</span> <span class="at">const</span> NumericVector y<span class="op">)</span> <span class="op">:</span></span>
<span id="cb209-19"><a href="chap-utiliseR.html#cb209-19" aria-hidden="true" tabindex="-1"></a>    Rx<span class="op">(</span>x<span class="op">),</span> Ry<span class="op">(</span>y<span class="op">),</span> distance<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb209-20"><a href="chap-utiliseR.html#cb209-20" aria-hidden="true" tabindex="-1"></a>  TotalDistanceWrkr<span class="op">(</span><span class="at">const</span> TotalDistanceWrkr<span class="op">&amp;</span> totalDistanceWrkr<span class="op">,</span> Split<span class="op">)</span> <span class="op">:</span></span>
<span id="cb209-21"><a href="chap-utiliseR.html#cb209-21" aria-hidden="true" tabindex="-1"></a>    Rx<span class="op">(</span>totalDistanceWrkr<span class="op">.</span>Rx<span class="op">),</span> Ry<span class="op">(</span>totalDistanceWrkr<span class="op">.</span>Ry<span class="op">),</span>  distance<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb209-22"><a href="chap-utiliseR.html#cb209-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-23"><a href="chap-utiliseR.html#cb209-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Comptage des voisins</span></span>
<span id="cb209-24"><a href="chap-utiliseR.html#cb209-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="bu">std::</span>size_t<span class="op"> </span>begin<span class="op">,</span> <span class="bu">std::</span>size_t<span class="op"> </span>end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb209-25"><a href="chap-utiliseR.html#cb209-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> dx<span class="op">,</span> dy<span class="op">;</span></span>
<span id="cb209-26"><a href="chap-utiliseR.html#cb209-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> Npoints <span class="op">=</span> Rx<span class="op">.</span>length<span class="op">();</span></span>
<span id="cb209-27"><a href="chap-utiliseR.html#cb209-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-28"><a href="chap-utiliseR.html#cb209-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> begin<span class="op">;</span> i <span class="op">&lt;</span> end<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb209-29"><a href="chap-utiliseR.html#cb209-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> j<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> Npoints<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb209-30"><a href="chap-utiliseR.html#cb209-30" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Calcul de la distance au carré</span></span>
<span id="cb209-31"><a href="chap-utiliseR.html#cb209-31" aria-hidden="true" tabindex="-1"></a>          dx <span class="op">=</span> Rx<span class="op">[</span>i<span class="op">]-</span>Rx<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb209-32"><a href="chap-utiliseR.html#cb209-32" aria-hidden="true" tabindex="-1"></a>          dy <span class="op">=</span> Ry<span class="op">[</span>i<span class="op">]-</span>Ry<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb209-33"><a href="chap-utiliseR.html#cb209-33" aria-hidden="true" tabindex="-1"></a>          distance <span class="op">+=</span> sqrt<span class="op">(</span>dx<span class="op">*</span>dx <span class="op">+</span> dy<span class="op">*</span>dy<span class="op">);</span></span>
<span id="cb209-34"><a href="chap-utiliseR.html#cb209-34" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb209-35"><a href="chap-utiliseR.html#cb209-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb209-36"><a href="chap-utiliseR.html#cb209-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb209-37"><a href="chap-utiliseR.html#cb209-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-38"><a href="chap-utiliseR.html#cb209-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Ajouter le résultat de cette tâche</span></span>
<span id="cb209-39"><a href="chap-utiliseR.html#cb209-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> join<span class="op">(</span><span class="at">const</span> TotalDistanceWrkr<span class="op">&amp;</span> rhs<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb209-40"><a href="chap-utiliseR.html#cb209-40" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">+=</span> rhs<span class="op">.</span>distance<span class="op">;</span> </span>
<span id="cb209-41"><a href="chap-utiliseR.html#cb209-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb209-42"><a href="chap-utiliseR.html#cb209-42" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb209-43"><a href="chap-utiliseR.html#cb209-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-44"><a href="chap-utiliseR.html#cb209-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-45"><a href="chap-utiliseR.html#cb209-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Fonction exportée</span></span>
<span id="cb209-46"><a href="chap-utiliseR.html#cb209-46" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb209-47"><a href="chap-utiliseR.html#cb209-47" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> TotalDistance<span class="op">(</span>NumericVector x<span class="op">,</span> NumericVector y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb209-48"><a href="chap-utiliseR.html#cb209-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-49"><a href="chap-utiliseR.html#cb209-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Declaration d'une instance de TotalDistanceWrkr</span></span>
<span id="cb209-50"><a href="chap-utiliseR.html#cb209-50" aria-hidden="true" tabindex="-1"></a>  TotalDistanceWrkr totalDistanceWrkr<span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb209-51"><a href="chap-utiliseR.html#cb209-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-52"><a href="chap-utiliseR.html#cb209-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Appel de parallel_reduce pour démarrer la tâche</span></span>
<span id="cb209-53"><a href="chap-utiliseR.html#cb209-53" aria-hidden="true" tabindex="-1"></a>  parallelReduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> x<span class="op">.</span>length<span class="op">(),</span> totalDistanceWrkr<span class="op">);</span></span>
<span id="cb209-54"><a href="chap-utiliseR.html#cb209-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-55"><a href="chap-utiliseR.html#cb209-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Retour du résultat</span></span>
<span id="cb209-56"><a href="chap-utiliseR.html#cb209-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> totalDistanceWrkr<span class="op">.</span>distance<span class="op">;</span></span>
<span id="cb209-57"><a href="chap-utiliseR.html#cb209-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>L’usage dans R est identique à celui des fonctions C++ interfacées par <strong>RCpp</strong>.</p>
<p></p>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">TotalDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span></span>
<span>    <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Unit: microseconds
##                                                      expr
##  d &lt;- TotalDistance(X$x, X$y)/NbPoints/(NbPoints - 1) * 2
##      min       lq     mean  median      uq      max neval
##  453.818 793.7715 816.4772 802.575 811.566 1636.121   100</code></pre>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># suppressmessages pour éliminer les messages superflus</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/RcppParallel-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>Le temps de mise en place des tâches parallèles est bien plus long que le temps de calcul en série.</p>
<p>En multipliant le nombre de points par 50, le temps de calcul en série doit être multiplié par 2500 environ.</p>
<p></p>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NbPoints</span> <span class="op">&lt;-</span> <span class="fl">50000</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">NbPoints</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">MeanDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   5.236   0.005   5.244</code></pre>
<p></p>
<p>En parallèle, le temps augmente peu: la parallélisation devient réellement efficace.
Ce temps est à comparer à celui de la boucle for de référence, multiplié par 2500, soit <code>3460</code> secondes.</p>
<p></p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">TotalDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">/</span><span class="va">NbPoints</span><span class="op">/</span><span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span></span>
<span>    <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.768   0.005   0.449</code></pre>
<p></p>
</div>
<div id="conclusions-sur-loptimisation-de-la-vitesse-du-code" class="section level3" number="2.7.8">
<h3>
<span class="header-section-number">2.7.8</span> Conclusions sur l’optimisation de la vitesse du code<a class="anchor" aria-label="anchor" href="#conclusions-sur-loptimisation-de-la-vitesse-du-code"><i class="fas fa-link"></i></a>
</h3>
<p>De cette étude de cas, plusieurs enseignements peuvent être retirés:</p>
<ul>
<li>une boucle for est une bonne base pour des calculs répétitifs, plus rapide que <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code>, simple à lire et à écrire;</li>
<li>des fonctions optimisées peuvent exister dans les packages de R pour des tâches courantes (ici, la fonction <code><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist()</a></code> de <strong>spatstat</strong> est deux ordres de grandeur plus rapide que la boucle for);</li>
<li>le recours au code C++ permet d’accélérer significativement les calculs, de trois ordres de grandeur ici;</li>
<li>la parallélisation du code C++ divise encore le temps de calcul par environ la moitié du nombre de cœurs pour de longs calculs.</li>
</ul>
<p>Au-delà de cet exemple, l’optimisation du temps de calcul sous R peut être compliquée si elle passe par la parallélisation et l’écriture de code C++.
L’effort doit donc être concentré sur les calculs réellement long alors que la lisibilité du code doit rester la priorité pour le code courant.
Le code C est assez facile à intégrer grâce à <strong>RCpp</strong> et sa parallélisation n’est pas très coûteuse avec <strong>RCppParallel</strong>.</p>
<p>L’utilisation de boucles for n’est plus pénalisante depuis la version 3.5 de R.
L’écriture de code vectoriel, utilisant <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> se justifie toujours pour sa lisibilité.</p>
<p>Le choix de paralléliser le code doit être évalué selon le temps d’exécution de chaque tâche parallélisable.
S’il dépasse quelques secondes, la parallélisation se justifie.
<code><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply()</a></code> remplace <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> sans aucun effort, mais nécessite un hack (fourni ici) sous Windows.
<code><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach()</a></code> ne remplace pas <code>for()</code> aussi simplement et ne se justifie que pour des tâches très lourdes en termes de mémoire et de temps de calcul, en particulier sur des clusters de calcul.</p>
</div>
</div>
<div id="sec:targets" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Flux de travail<a class="anchor" aria-label="anchor" href="#sec:targets"><i class="fas fa-link"></i></a>
</h2>
<p>Le package <strong>targets</strong> permet de gérer un flux de travail (<em>workflow</em>), c’est-à dire de décomposer le code en tâches élémentaires appelées <em>cibles</em> qui s’enchaînent, dont le résultat est stocké dans une variable, elle-même enregistrée sur le disque.
En cas de changement dans le code ou les données utilisées, seules les cibles concernées sont réévaluées.</p>
<p>Le fonctionnement du flux est proche de celui d’un cache, mais ne dépend pas de l’ordinateur sur lequel il s’exécute.
<strong>targets</strong> permet de visualiser les tâches obsolètes, d’intégrer le flux à un projet de document (voir section <a href="chap-rediger.html#sec:targetsmd">4.9</a>), et même de faire appel à un cluster de calcul pour traiter les tâches en parallèle.</p>
<div id="principe-de-fonctionnement" class="section level3" number="2.8.1">
<h3>
<span class="header-section-number">2.8.1</span> Principe de fonctionnement<a class="anchor" aria-label="anchor" href="#principe-de-fonctionnement"><i class="fas fa-link"></i></a>
</h3>
<p>La documentation<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://books.ropensci.org/targets/" class="uri"&gt;https://books.ropensci.org/targets/&lt;/a&gt;&lt;/p&gt;'><sup>28</sup></a> de <strong>targets</strong> est détaillée et fournit un exemple travaillé pour apprendre à utiliser le package<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://books.ropensci.org/targets/walkthrough.html" class="uri"&gt;https://books.ropensci.org/targets/walkthrough.html&lt;/a&gt;&lt;/p&gt;'><sup>29</sup></a>.
Elle n’est pas reprise ici, mais les principes du fonctionnement du flux sont expliqués.</p>
<p>Le flux de travail est unique pour un projet donné.
Il est codé dans le fichier <code>_targets.R</code> à la racine du projet.
Il contient:</p>
<ul>
<li>des commandes globales, comme le chargement des packages;</li>
<li>une liste de cibles, qui décrivent le code à exécuter et la variable qui stocke leur résultat.</li>
</ul>
<p>Le flux est exécuté par la fonction <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code> qui met à jour les cibles qui le nécessitent.
Son contenu est placé dans le dossier <code>_targets</code>.
Les variables stockées sont lues par <code><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read()</a></code>.</p>
<p>Si le projet nécessite de longs calculs, <strong>targets</strong> permet de n’exécuter que ceux qui sont nécessaires.
Si le projet est partagé ou placé sous contrôle de source (chapitre <a href="chap-git.html#chap-git">3</a>), le résultat des calcul est intégré l’est aussi.
Enfin, si le projet est un document (chapitre <a href="chap-rediger.html#chap-rediger">4</a>), son formatage est complètement indépendant du calcul de son contenu, pour un gain de temps qui peut être considérable.</p>
</div>
<div id="exemple-minimal" class="section level3" number="2.8.2">
<h3>
<span class="header-section-number">2.8.2</span> Exemple minimal<a class="anchor" aria-label="anchor" href="#exemple-minimal"><i class="fas fa-link"></i></a>
</h3>
<p>L’exemple suivant est encore plus simple que celui du manuel de <strong>targets</strong>, qui permettra d’aller plus loin.
Il reprend l’étude de cas précédente: un jeu de points est généré puis la distance moyenne entre les points obtenus est calculée.
Une carte des points est tracée en plus.
Chacune de ces trois opérations est une cible dans le vocabulaire de <strong>targets</strong>.</p>
<p>Le fichier du flux de travail est donc le suivant:</p>
<p></p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fichier _targets.R </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/targets/">"targets"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_option_set.html">tar_option_set</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"spatstat"</span>, <span class="st">"dbmss"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Tirage des points</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">X</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">NbPoints</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Paramétrage</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">NbPoints</span>,</span>
<span>    <span class="fl">1000</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Distance moyenne</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">d</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">NbPoints</span> <span class="op">/</span> <span class="op">(</span><span class="va">NbPoints</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Carte</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">map</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="fu">as.wmppp</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Les commandes globales consistent à charger le package <strong>targets</strong> lui-même puis lister les packages nécessaires au code.
L’exécution du flux a lieu dans une nouvelle instance de R.</p>
<p>Les cibles sont ensuite listées.
Chacune est déclarée par la fonction <code><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target()</a></code> dont le premier argument est le nom de la cible, qui sera celui de la variable qui recevra le résultat.
Le deuxième argument est le code qui produit le résultat.
Les cibles sont très simples ici et peuvent être écrites en une seule commande.
Quand ce n’est pas le cas, chaque cible peut être écrite sous la forme d’une fonction, stockée dans un fichier de code séparé chargé par la fonction <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> au début du fichier de flux.</p>
<p>La commande <code>tar_visnetwork</code> permet d’afficher l’enchaînement des cibles et leur état éventuellement obsolète.</p>
<p></p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/targets/">"targets"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-4c2873e5859f69562509" style="width:80%;height:504px;"></div>
<script type="application/json" data-for="htmlwidget-4c2873e5859f69562509">{"x":{"nodes":{"name":["d","map","NbPoints","X"],"type":["stem","stem","stem","stem"],"status":["outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null],"bytes":[null,null,null,null],"branches":[null,null,null,null],"label":["d","map","NbPoints","X"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["d","map","NbPoints","X"],"level":[3,3,1,2],"shape":["dot","dot","dot","dot"]},"edges":{"from":["NbPoints","NbPoints","X","X"],"to":["X","d","d","map"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Stem"],"color":["#78B7C5","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script><p></p>
<p>L’ordre de déclaration des cibles dans la liste sans importance: elles sont ordonnées automatiquement.</p>
<p>Le flux est exécuté par <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## ▶ start target NbPoints
## ● built target NbPoints [1.477 seconds]
## ▶ start target X
## ● built target X [0.004 seconds]
## ▶ start target d
## ● built target d [0.029 seconds]
## ▶ start target map
## ● built target map [0.028 seconds]
## ▶ end pipeline [1.673 seconds]</code></pre>
<p></p>
<p>Le flux est maintenant à jour et <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code> ne refait aucun calcul.</p>
<p></p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-c5409db81165a82e2db3" style="width:80%;height:504px;"></div>
<script type="application/json" data-for="htmlwidget-c5409db81165a82e2db3">{"x":{"nodes":{"name":["d","map","NbPoints","X"],"type":["stem","stem","stem","stem"],"status":["uptodate","uptodate","uptodate","uptodate"],"seconds":[0.029,0.028,1.477,0.004],"bytes":[55,119028,53,11045],"branches":[null,null,null,null],"label":["d","map","NbPoints","X"],"color":["#354823","#354823","#354823","#354823"],"id":["d","map","NbPoints","X"],"level":[3,3,1,2],"shape":["dot","dot","dot","dot"]},"edges":{"from":["NbPoints","NbPoints","X","X"],"to":["X","d","d","map"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Stem"],"color":["#354823","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script><div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## ✔ skip target NbPoints
## ✔ skip target X
## ✔ skip target d
## ✔ skip target map
## ✔ skip pipeline [0.081 seconds]</code></pre>
<p></p>
<p>Les résultats sont lus par <code><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.5189867</code></pre>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/tar_read-1.png" width="80%" style="display: block; margin: auto;"></div>
<p></p>
</div>
<div id="intérêt-pratique" class="section level3" number="2.8.3">
<h3>
<span class="header-section-number">2.8.3</span> Intérêt pratique<a class="anchor" aria-label="anchor" href="#int%C3%A9r%C3%AAt-pratique"><i class="fas fa-link"></i></a>
</h3>
<p>Dans cet exemple, <strong>targets</strong> complique l’écriture du code et <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code> est beaucoup plus lent que la simple exécution du code qu’il traite parce qu’il doit vérifier si les cibles sont à jour.
Dans un projet réel qui nécessite de longs calculs, le traitement du statut des cibles est négligeable et le gain de temps apporté par la seule évaluation des cibles nécessaires est considérable.
La définition des cibles reste une contrainte, mais force à bien structurer son projet.</p>

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="chap-logiciels.html"><span class="header-section-number">1</span> Logiciels</a></div>
<div class="next"><a href="chap-git.html"><span class="header-section-number">3</span> Git et GitHub</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-utiliseR"><span class="header-section-number">2</span> Utiliser R</a></li>
<li>
<a class="nav-link" href="#les-langages-de-r"><span class="header-section-number">2.1</span> Les langages de R</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#base"><span class="header-section-number">2.1.1</span> Base</a></li>
<li><a class="nav-link" href="#sec:S3"><span class="header-section-number">2.1.2</span> S3</a></li>
<li><a class="nav-link" href="#s4"><span class="header-section-number">2.1.3</span> S4</a></li>
<li><a class="nav-link" href="#rc"><span class="header-section-number">2.1.4</span> RC</a></li>
<li><a class="nav-link" href="#s6"><span class="header-section-number">2.1.5</span> S6</a></li>
<li><a class="nav-link" href="#tidyverse"><span class="header-section-number">2.1.6</span> Tidyverse</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec:environnements"><span class="header-section-number">2.2</span> Environnements</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#organisation"><span class="header-section-number">2.2.1</span> Organisation</a></li>
<li><a class="nav-link" href="#recherche"><span class="header-section-number">2.2.2</span> Recherche</a></li>
<li><a class="nav-link" href="#espaces-de-nom-des-packages"><span class="header-section-number">2.2.3</span> Espaces de nom des packages</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#mesure-du-temps-dex%C3%A9cution"><span class="header-section-number">2.3</span> Mesure du temps d’exécution</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#system.time"><span class="header-section-number">2.3.1</span> system.time</a></li>
<li><a class="nav-link" href="#microbenchmark"><span class="header-section-number">2.3.2</span> microbenchmark</a></li>
<li><a class="nav-link" href="#profilage"><span class="header-section-number">2.3.3</span> Profilage</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#boucles"><span class="header-section-number">2.4</span> Boucles</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#fonctions-vectorielles"><span class="header-section-number">2.4.1</span> Fonctions vectorielles</a></li>
<li><a class="nav-link" href="#lapply"><span class="header-section-number">2.4.2</span> lapply</a></li>
<li><a class="nav-link" href="#boucles-for"><span class="header-section-number">2.4.3</span> Boucles for</a></li>
<li><a class="nav-link" href="#replicate"><span class="header-section-number">2.4.4</span> replicate</a></li>
<li><a class="nav-link" href="#vectorize"><span class="header-section-number">2.4.5</span> Vectorize</a></li>
<li><a class="nav-link" href="#statistiques-marginales"><span class="header-section-number">2.4.6</span> Statistiques marginales</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec:cpp"><span class="header-section-number">2.5</span> Code C++</a></li>
<li>
<a class="nav-link" href="#parall%C3%A9liser-r"><span class="header-section-number">2.6</span> Paralléliser R</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mclapply-fork"><span class="header-section-number">2.6.1</span> mclapply (fork)</a></li>
<li><a class="nav-link" href="#parlapply-socket"><span class="header-section-number">2.6.2</span> parLapply (socket)</a></li>
<li><a class="nav-link" href="#foreach"><span class="header-section-number">2.6.3</span> foreach</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec:cas"><span class="header-section-number">2.7</span> Etude de cas</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#cr%C3%A9ation-des-donn%C3%A9es"><span class="header-section-number">2.7.1</span> Création des données</a></li>
<li><a class="nav-link" href="#spatstat"><span class="header-section-number">2.7.2</span> Spatstat</a></li>
<li><a class="nav-link" href="#apply"><span class="header-section-number">2.7.3</span> apply</a></li>
<li><a class="nav-link" href="#boucle-for"><span class="header-section-number">2.7.4</span> boucle for</a></li>
<li><a class="nav-link" href="#boucle-foreach"><span class="header-section-number">2.7.5</span> boucle foreach</a></li>
<li><a class="nav-link" href="#rcpp"><span class="header-section-number">2.7.6</span> RCpp</a></li>
<li><a class="nav-link" href="#rcppparallel"><span class="header-section-number">2.7.7</span> RcppParallel</a></li>
<li><a class="nav-link" href="#conclusions-sur-loptimisation-de-la-vitesse-du-code"><span class="header-section-number">2.7.8</span> Conclusions sur l’optimisation de la vitesse du code</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec:targets"><span class="header-section-number">2.8</span> Flux de travail</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#principe-de-fonctionnement"><span class="header-section-number">2.8.1</span> Principe de fonctionnement</a></li>
<li><a class="nav-link" href="#exemple-minimal"><span class="header-section-number">2.8.2</span> Exemple minimal</a></li>
<li><a class="nav-link" href="#int%C3%A9r%C3%AAt-pratique"><span class="header-section-number">2.8.3</span> Intérêt pratique</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/EricMarcon/travailleR/blob/master/02-UtiliseR.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/EricMarcon/travailleR/edit/master/02-UtiliseR.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Travailler avec R</strong>" was written by Eric Marcon. It was last built on 04/11/2023.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
