<!DOCTYPE html>
<html lang="fr-FR">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Package | Travailler avec R</title>
<meta name="author" content="Eric Marcon">
<meta name="description" content="Les packages de R permettent d’étendre les fonctionnalités du logiciel par du code fourni par la communauté des développeurs. Ils sont la clé du succès de R parce qu’ils permettent de diffuser...">
<meta name="generator" content="bookdown 0.37 with bs4_book()">
<meta property="og:title" content="5 Package | Travailler avec R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ericmarcon.github.io/travailleR/chap-package.html">
<meta property="og:description" content="Les packages de R permettent d’étendre les fonctionnalités du logiciel par du code fourni par la communauté des développeurs. Ils sont la clé du succès de R parce qu’ils permettent de diffuser...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5 Package | Travailler avec R">
<meta name="twitter:description" content="Les packages de R permettent d’étendre les fonctionnalités du logiciel par du code fourni par la communauté des développeurs. Ils sont la clé du succès de R parce qu’ils permettent de diffuser...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-7NVD1TWMCJ"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7NVD1TWMCJ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Travailler avec R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Présentation</a></li>
<li><a class="" href="chap-logiciels.html"><span class="header-section-number">1</span> Logiciels</a></li>
<li><a class="" href="chap-utiliseR.html"><span class="header-section-number">2</span> Utiliser R</a></li>
<li><a class="" href="chap-git.html"><span class="header-section-number">3</span> Git et GitHub</a></li>
<li><a class="" href="chap-rediger.html"><span class="header-section-number">4</span> Rédiger</a></li>
<li><a class="active" href="chap-package.html"><span class="header-section-number">5</span> Package</a></li>
<li><a class="" href="chap-ci.html"><span class="header-section-number">6</span> Intégration continue</a></li>
<li><a class="" href="chap-shiny.html"><span class="header-section-number">7</span> Shiny</a></li>
<li><a class="" href="chap-enseigner.html"><span class="header-section-number">8</span> Enseigner avec R</a></li>
<li><a class="" href="chap-conclusion.html"><span class="header-section-number">9</span> Conclusion</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/EricMarcon/travailleR">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-package" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Package<a class="anchor" aria-label="anchor" href="#chap-package"><i class="fas fa-link"></i></a>
</h1>
<p>Les packages de R permettent d’étendre les fonctionnalités du logiciel par du code fourni par la communauté des développeurs.
Ils sont la clé du succès de R parce qu’ils permettent de diffuser rapidement de nouvelles méthodes issues de la recherche ou d’ajouter de nouveaux outils qui peuvent devenir des standards, comme le <strong>tidyverse</strong>.</p>
<p>Il est utile de produire un package quand on a écrit des nouvelles fonctions qui forment un ensemble cohérent.
Un package à usage personnel ou limité à une équipe de travail est simple à mettre en place et le temps gagné en utilisant facilement la version à jour de chaque fonction amortit très rapidement le temps consacré à la fabrication du package.
Ce type de package a vocation à être hébergé sur GitHub.</p>
<p>Des packages à usage plus large, qui fournissent par exemple le code correspondant à une méthode publiée, sont placés dans le dépôt CRAN, d’où ils pourront être installés par la commande standard <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>.
CRAN effectue des vérifications poussées du code et n’accepte que les packages passant sans aucun avertissement sa batterie de tests.
Ils doivent respecter la politique<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://cran.r-project.org/web/packages/policies.html" class="uri"&gt;https://cran.r-project.org/web/packages/policies.html&lt;/a&gt;&lt;/p&gt;'><sup>97</sup></a> du dépôt.</p>
<p>La documentation pour la création de packages est abondante.
L’ouvrage de référence est celui de <span class="citation">Wickham (<a href="references.html#ref-Wickham2015" role="doc-biblioref">2015</a>)</span>, à consulter en tant que référence.</p>
<p>L’approche utilisée ici consiste à créer un premier package très rapidement pour comprendre que la démarche est assez simple.
Il sera ensuite enrichi des éléments nécessaires à un package diffusé à d’autres utilisateurs que son concepteur : une documentation complète et des tests de bon fonctionnement notamment.</p>
<div id="premier-package" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Premier package<a class="anchor" aria-label="anchor" href="#premier-package"><i class="fas fa-link"></i></a>
</h2>
<p>Cette introduction reprend les recommandations du blog <em>Créer un package en quelques minutes</em><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://thinkr.fr/creer-package-r-quelques-minutes/" class="uri"&gt;https://thinkr.fr/creer-package-r-quelques-minutes/&lt;/a&gt;&lt;/p&gt;'><sup>98</sup></a> de ThinkR.</p>
<div id="création" class="section level3" number="5.1.1">
<h3>
<span class="header-section-number">5.1.1</span> Création<a class="anchor" aria-label="anchor" href="#cr%C3%A9ation"><i class="fas fa-link"></i></a>
</h3>
<p>Les packages ont une organisation stricte dans une structure de fichiers et de répertoires figée.
Il est possible de créer cette structure manuellement mais des packages spécialisés peuvent s’en charger :</p>
<ul>
<li>
<strong>usethis</strong> automatise la création des <span style="white-space:nowrap">dossiers ;</span>
</li>
<li>
<strong>roxygen2</strong> permet d’automatiser la documentation obligatoire des <span style="white-space:nowrap">packages ;</span>
</li>
<li>
<strong>devtools</strong> est la boîte à outils du développeur, permettant notamment de construire et tester les <span style="white-space:nowrap">packages ;</span>
</li>
</ul>
<p>Les trois sont à installer en premier lieu :</p>
<p></p>
<div class="sourceCode" id="cb350"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"usethis"</span>, <span class="st">"roxygen2"</span>, <span class="st">"devtools"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Le package à créer sera un projet RStudio.
Dans le menu des projets, sélectionner “New Project &gt; New Directory &gt; R package using devtools…”, choisir le nom du projet et son dossier parent.
Le package s’appellera <strong>multiple</strong>, dans le dossier <code>%LOCALAPPDATA%\ProjetsR</code> en suivant les recommandations de la section <a href="chap-logiciels.html#sec:solution-dossiers">1.2.4</a>.</p>
<p>Le nom du package doit respecter les contraintes des noms de projets : pas de caractères spéciaux, pas d’espaces…
Il doit aussi être évocateur de l’objet du package.
Si le package doit être diffusé, toute sa documentation sera rédigée en Anglais, y compris son nom.</p>
<p>La structure minimale est crée :</p>
<ul>
<li>un fichier <code>DESCRIPTION</code> qui indique que le dossier contient un package et précise au minimum son <span style="white-space:nowrap">nom ;</span>
</li>
<li>un fichier <code>NAMESPACE</code> qui déclare comment le package intervient dans la gestion des noms des objets de R (son contenu sera mis à jour par <strong>roxygen2</strong><span style="white-space:nowrap">) ;</span>
</li>
<li>un dossier <code>R</code> qui contient le code des fonctions offertes par le package (vide à ce stade).</li>
</ul>
<p>Le package peut être testé tout de suite : dans la fenêtre <em>Build</em> de RStudio, cliquer sur “Install and Restart” construit le package et le charge dans R, après avoir redémarré le programme pour éviter tout conflit.</p>
<p>Dans la fenêtre <em>Packages</em>, <strong>multiple</strong> est maintenant visible.
Il est chargé, mais ne contient rien.</p>
</div>
<div id="première-fonction" class="section level3" number="5.1.2">
<h3>
<span class="header-section-number">5.1.2</span> Première fonction<a class="anchor" aria-label="anchor" href="#premi%C3%A8re-fonction"><i class="fas fa-link"></i></a>
</h3>
<div id="fichiers" class="section level4" number="5.1.2.1">
<h4>
<span class="header-section-number">5.1.2.1</span> Fichiers<a class="anchor" aria-label="anchor" href="#fichiers"><i class="fas fa-link"></i></a>
</h4>
<p>Les fonctions sont placées dans un ou plusieurs fichier <code>.R</code> dans le dossier <code>R</code>.
L’organisation de ces fichiers est libre.
Pour cet exemple, un fichier du nom de chaque fonction sera créé.
Des fichiers regroupant les fonctions similaires ou un seul fichier contenant tout le code sont des choix possibles.</p>
<p>Le choix fait ici est le suivant :</p>
<ul>
<li>un fichier qui contiendra le code commun à tout le package : <code>package.R</code><span style="white-space:nowrap"> ;</span>
</li>
<li>un fichier commun à toutes les fonctions : <code>fonctions.R</code>.</li>
</ul>
</div>
<div id="création-1" class="section level4" number="5.1.2.2">
<h4>
<span class="header-section-number">5.1.2.2</span> Création<a class="anchor" aria-label="anchor" href="#cr%C3%A9ation-1"><i class="fas fa-link"></i></a>
</h4>
<p>La première fonction, <code><a href="https://rdrr.io/r/base/double.html">double()</a></code>, est créée et enregistrée dans le fichier <code>fonctions.R</code> :</p>
<p></p>
<div class="sourceCode" id="cb351"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>A ce stade, la fonction est interne au package et n’est pas accessible depuis l’environnement de travail.
Pour s’en persuader, construire le package (<em>Install and Restart</em>) et vérifier le bon fonctionnement de la fonction :</p>
<p></p>
<div class="sourceCode" id="cb352"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Le résultat est un vecteur composé de deux 0 parce que la fonction appelée est un homonyme du package <strong>base</strong> (voir sa documentation en tapant <code><a href="https://rdrr.io/r/base/double.html">?double</a></code>) :</p>
<p></p>
<div class="sourceCode" id="cb353"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0 0</code></pre>
<p></p>
<p>Pour que la fonction de notre package soit visible, elle doit être <em>exportée</em> en la déclarant dans le fichier <code>NAMESPACE</code>.
C’est le travail de <strong>roxygen2</strong> qui gère en même temps la documentation de chaque fonction.
Pour l’activer, placer le curseur dans la fonction et appeler le menu “Code &gt; Insert Roxygen Skeleton”.
Des commentaires sont ajoutés avant la fonction :</p>
<p></p>
<div class="sourceCode" id="cb355"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Title</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param number </span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="va">double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Les commentaires à destination de <strong>roxygen2</strong> commencent par <code>#'</code> :</p>
<ul>
<li>la première ligne contient le titre de la fonction, c’est-à-dire un descriptif très court : son nom en <span style="white-space:nowrap">général ;</span>
</li>
<li>la ligne suivante (séparée par un saut de ligne) peut contenir sa description (rubrique <em>Description</em> dans <span style="white-space:nowrap">l’aide) ;</span>
</li>
<li>la suivante (après un autre saut de ligne) peut contenir plus d’informations (rubrique <em>Details</em> dans <span style="white-space:nowrap">l’aide) ;</span>
</li>
<li>les arguments de la fonction sont décrits par les lignes <code>@param</code><span style="white-space:nowrap"> ;</span>
</li>
<li>
<code>@return</code> décrit le résultat de la <span style="white-space:nowrap">fonction ;</span>
</li>
<li>
<code>@export</code> déclare que la fonction est exportée : elle sera donc utilisable dans l’environnement de <span style="white-space:nowrap">travail ;</span>
</li>
<li>des exemples peuvent être ajoutés.</li>
</ul>
<p>La documentation doit être complétée :</p>
<p></p>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' double</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Double value of numbers.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Calculate the double values of numbers.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @param number a numeric vector.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A vector of the same length as `number` containing the </span></span>
<span><span class="co">#'   transformed values.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' double(2)</span></span>
<span><span class="co">#' double(1:4)</span></span>
<span><span class="va">double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Ne pas hésiter à s’inspirer de l’aide de fonctions existantes pour respecter les standards de R (ici : <code><a href="https://rdrr.io/r/base/Log.html">?log</a></code>) :</p>
<ul>
<li>penser que les fonctions sont normalement vectorielles : <code>number</code> est par défaut un vecteur, pas un <span style="white-space:nowrap">scalaire ;</span>
</li>
<li>certains éléments commencent par une majuscule et se terminent par un point parce que ce sont des paragraphes dans le fichier <span style="white-space:nowrap">d’aide ;</span>
</li>
<li>le titre n’a pas de point <span style="white-space:nowrap">final ;</span>
</li>
<li>la description des paramètres ne commence pas par une majuscule.</li>
</ul>
<p>La prise en compte des changements dans la documentation nécessitent d’appeler la fonction <code>roxygenize()</code>.
Dans la fenêtre <em>Build</em>, le menu “More &gt; Document” permet de le faire.
Ensuite, construire le package (<em>Install and Restart</em>) et vérifier le résultat en exécutant la fonction et en affichant son aide :</p>
<p></p>
<div class="sourceCode" id="cb357"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">`?`</span><span class="op">(</span><span class="va">double</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Il est possible d’automatiser la mise à jour de la documentation à chaque construction du package par le menu “Build &gt; Configure Build Tools…” : cliquer sur “Configure” et cocher la case “Automatically reoxygenize when running Install and Restart”.
C’est un choix efficace pour un petit package mais pénalisant quand le temps de mise à jour de la documentation s’allonge avec la complexité du package. La reconstruction du package est le plus souvent utilisée pour tester des modifications du code : sa rapidité est essentielle.</p>
<p>La documentation pour <strong>roxygen2</strong> supporte le format Markdown<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://roxygen2.r-lib.org/articles/markdown.html" class="uri"&gt;https://roxygen2.r-lib.org/articles/markdown.html&lt;/a&gt;&lt;/p&gt;'><sup>99</sup></a>.</p>
<p>A ce stade, le package est fonctionnel : il contient une fonction et un début de documentation.
Il est temps de lancer une vérification de son code : dans la fenêtre <em>Build</em>, cliquer sur “Check” ou utiliser la commande <code>devtools::check()</code>.
L’opération <em>réoxygène</em> le package (met à jour sa documentation), effectue un grand nombre de tests et renvoie la liste des erreurs, avertissements et notes détectées.
L’objectif est toujours de n’avoir aucune alerte : elles doivent être traitées immédiatement.
Par exemple, le retour suivant est un avertissement sur la non-conformité de la licence déclarée :</p>
<pre><code>&gt; checking DESCRIPTION meta-information ... WARNING
  Non-standard license specification:
    `use_gpl3_license()`
  Standardizable: FALSE

0 errors v | 1 warning x | 0 notes v
Erreur : R CMD check found WARNINGs</code></pre>
<p>Pour la corriger, mettre à jour, exécuter la commande de mise à jour de la licence, en commençant par votre nom :</p>
<p></p>
<div class="sourceCode" id="cb359"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>usethis.full_name <span class="op">=</span> <span class="st">"Eric Marcon"</span><span class="op">)</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/licenses.html">use_gpl3_license</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>La liste des licences valides est fournie par R<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://svn.r-project.org/R/trunk/share/licenses/license.db" class="uri"&gt;https://svn.r-project.org/R/trunk/share/licenses/license.db&lt;/a&gt;&lt;/p&gt;'><sup>100</sup></a>.</p>
<p>Après correction, relancer les tests jusqu’à la disparition des alertes.</p>
</div>
</div>
<div id="sec:package-cds" class="section level3" number="5.1.3">
<h3>
<span class="header-section-number">5.1.3</span> Contrôle de source<a class="anchor" aria-label="anchor" href="#sec:package-cds"><i class="fas fa-link"></i></a>
</h3>
<p>Il est temps de placer le code sous contrôle de source.</p>
<p>Activer le contrôle de source dans les options du projet (figure <a href="chap-git.html#fig:git-Project">3.2</a>).
Redémarrer RStudio à la demande.</p>
<p>Créer un dépôt sur GitHub et y pousser le dépôt local, comme expliqué dans le chapitre <a href="chap-git.html#chap-git">3</a>.</p>
<p>Créer le fichier <code>README.md</code> :</p>
<pre><code># multiple

An R package to compute mutiple of numbers.</code></pre>
<p>Le développement du package est ponctué par de nombreux commits à chaque modification et une publication (push) à chaque étape, validée par une incrémentation du numéro de version.</p>
</div>
<div id="package.r" class="section level3" number="5.1.4">
<h3>
<span class="header-section-number">5.1.4</span> package.R<a class="anchor" aria-label="anchor" href="#package.r"><i class="fas fa-link"></i></a>
</h3>
<p>Le fichier <code>package.R</code> est destiné à recevoir le code R et surtout les commentaires pour <strong>roxygen2</strong> qui concernent l’ensemble du package.
Ce fichier peut aussi être nommé <code>multiple-package.R</code>, en préfixant son nom par celui du package, par souci de compatibilité avec <strong>usethis</strong>.
Il peut d’ailleurs être créé sous ce nom par la commande :</p>
<p></p>
<div class="sourceCode" id="cb361"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_package_doc.html">use_package_doc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Le premier bloc de commentaire fournira l’aide du package (<code>?multiple</code>).</p>
<pre><code>#' @keywords internal 
"_PACKAGE"</code></pre>
<p>Le mot-clé “_PACKAGE” indique que la documentation du package doit être produite.
Elle pourrait être écrite dans le bloc, avec une syntaxe identique à celle des fonctions, mais son contenu par défaut est celui du champ <code>Description</code> du fichier <code>DESCRIPTION</code>.
Le mot clé <code>internal</code> masque la documentation du package dans le sommaire de son aide.</p>
<p>La documentation est mise à jour par la commande <code>roxygen2::roxygenise()</code>.
Après reconstruction du package, vérifier que l’aide est est apparue : <code>?multiple</code>.</p>
</div>
</div>
<div id="organisation-du-package" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Organisation du package<a class="anchor" aria-label="anchor" href="#organisation-du-package"><i class="fas fa-link"></i></a>
</h2>
<div id="sec:package-description" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Fichier DESCRIPTION<a class="anchor" aria-label="anchor" href="#sec:package-description"><i class="fas fa-link"></i></a>
</h3>
<p>Le fichier doit être complété :</p>
<pre><code>Package: multiple
Title: Calculate multiples of numbers
Version: 0.0.0.9000
Authors@R: 
  person(given = "Eric",
           family = "Marcon",
           role = c("aut", "cre"),
           email = "e.marcon@free.fr",
           comment = c(ORCID = "0000-0002-5249-321X"))
Description: Simple computation of multiples of numbers, 
  including fast algorithms for integers.
License: GPL-3
Encoding: UTF-8
LazyData: true
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.1.1</code></pre>
<p>Le nom du package est figé et ne doit pas être modifié.</p>
<p>Son titre doit décrire en une ligne à quoi il sert.
Le titre est affiché dans la fenêtre <em>Packages</em> à côté des noms des packages.</p>
<p>La version doit respecter les conventions :</p>
<ul>
<li>Le premier nombre est la version majeure, 0 tant que le package n’est pas stable puis 1.
La version majeure ne change que si le package n’est plus compatible avec ses versions précédentes, ce qui oblige les utilisateurs à modifier leur code.</li>
<li>Le deuxième est la version mineure, incrémentée quand des fonctionnalités nouvelles sont ajoutées.</li>
<li>Le troisième est la version de correction : 0 à l’origine, incrémentée à chaque correction de code sans nouvelle fonctionnalité.</li>
<li>Le quatrième est réservé au développement, et commence à 9000.
Il est incrémenté à chaque version instable et disparaît quand une nouvelle version stable (<em>release</em>) est produite.</li>
</ul>
<p>Exemple : une correction de bug sur la version 1.3.0 produit la version 1.3.1.
Les versions de développement suivantes (instables, non destinées à l’usage en production) sont 1.3.1.9000 puis 1.3.1.9001, etc.
Le numéro de version doit être mis à jour à chaque fois que le package est poussé sur GitHub.
Quand le développement est stabilisé, la nouvelle version, destinée à être utilisée en production, est 1.3.2 si elle n’apporte pas de nouvelle fonctionnalité ou 1.4.0 dans le cas contraire.</p>
<p>La description des auteurs est assez lourde mais simple à comprendre.
Les identifiants Orcid des auteurs académiques peuvent être utilisés.
Si le package a plusieurs auteurs, ils sont placés dans une fonction <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> : <code>c(person(...), person(...))</code> pour deux auteurs.
Dans ce cas, il faut préciser le rôle de chacun :</p>
<ul>
<li>“cre” pour le créateur du <span style="white-space:nowrap">package ;</span>
</li>
<li>“aut” pour un auteur parmi les <span style="white-space:nowrap">autres ;</span>
</li>
<li>“ctb” pour un contributeur, qui peut avoir signalé un bug ou fourni un peu de code.</li>
</ul>
<p>La description du package en un paragraphe permet de donner plus d’informations.</p>
<p>La licence précise la façon dont le package peut être utilisé et modifié.
GPL-3 est une bonne valeur par défaut, mais d’autres choix sont possibles<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r-pkgs.org/description.html#description-license" class="uri"&gt;https://r-pkgs.org/description.html#description-license&lt;/a&gt;&lt;/p&gt;'><sup>101</sup></a>.</p>
<p>L’option <code>LazyData</code> signifie que les données d’exemples fournies avec le package peuvent être utilisées sans les appeler au préalable par la fonction <code><a href="https://rdrr.io/r/utils/data.html">data()</a></code> : c’est le standard actuel.</p>
<p>Enfin, les deux dernières lignes sont gérées par <strong>roxygen2</strong>.</p>
</div>
<div id="fichier-news.md" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> Fichier NEWS.md<a class="anchor" aria-label="anchor" href="#fichier-news.md"><i class="fas fa-link"></i></a>
</h3>
<p>Le fichier <code>NEWS.md</code> contient l’historique du package.
Les nouvelles versions sont ajoutées en haut du fichier.</p>
<p>Créer une première version du fichier :</p>
<pre><code># multiple 0.0.0.9000

## New features

* Initial version of the package</code></pre>
<p>Les titres de premier niveau doivent contenir le nom du package et sa version.
Les titres de niveau 2 sont libres, mais contiennent en général des rubriques comme “New features” et “Bug Fixes”.</p>
<p>Pour ne pas multiplier les versions décrites, il est conseillé de modifier la version en cours et de compléter la documentation jusqu’au changement de version de correction (troisième nombre).
Ensuite, l’entrée correspondant à cette version reste figée et une nouvelle entrée est ajoutée.</p>
</div>
</div>
<div id="vignette" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Vignette<a class="anchor" aria-label="anchor" href="#vignette"><i class="fas fa-link"></i></a>
</h2>
<p>Une vignette est indispensable pour documenter correctement le package :</p>
<p></p>
<div class="sourceCode" id="cb365"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_vignette.html">use_vignette</a></span><span class="op">(</span><span class="st">"multiple"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Le fichier <code>multiple.Rmd</code> est créé dans le dossier <code>vignettes</code>.
Ajouter un sous-titre dans son entête : la description courte du package :</p>
<pre><code>title: "multiple"
subtitle: "Multiples of numbers"</code></pre>
<p>Le reste de l’entête permet à R de construire la vignette à partir de code R Markdown.</p>
<p>Le corps de la vignette contient par défaut du code R pour déclarer les options de présentation des bouts de code et le chargement du package.
Une introduction à l’utilisation du package doit être écrite dans ce document, en R Markdown.</p>
<p>Pendant le développement du package, la vignette peut être construite manuellement en exécutant :</p>
<p></p>
<div class="sourceCode" id="cb367"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build_vignettes</span><span class="op">(</span><span class="st">"multiple"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Les fichiers produits sont placés dans <code>doc/</code> : ouvrir le fichier <code>.html</code> pour contrôler le résultat.</p>
<p>RStudio ne crée pas la vignette du package quand la commande “Install and Restart” de la fenêtre Build est appelée.
Pour une installation complète, deux solutions sont possibles :</p>
<ul>
<li>Construire le fichier source du package (“Build &gt; More &gt; Build Source Package”) puis l’installer (“Packages &gt; Install &gt; Install from &gt; Package Archive file”).
Le fichier source se trouve à côté de celui du projet.</li>
<li>Pousser le code du package sur GitHub puis exécuter :</li>
</ul>
<p></p>
<div class="sourceCode" id="cb368"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"multiple"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>La vignette peut ensuite être affichée par la commande :</p>
<p></p>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"multiple"</span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="pkgdown" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> pkgdown<a class="anchor" aria-label="anchor" href="#pkgdown"><i class="fas fa-link"></i></a>
</h2>
<p>Le package <strong>pkgdown</strong> permet de créer un site d’accompagnement du package<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Exemple : &lt;a href="https://EricMarcon.github.io/entropart/" class="uri"&gt;https://EricMarcon.github.io/entropart/&lt;/a&gt;&lt;/p&gt;'><sup>102</sup></a>, qui reprend le fichier <code>README.md</code> comme page d’accueil, la vignette dans une rubrique “Get Started”, l’ensemble des fichiers d’aide avec leurs exemples exécutés (section “Reference”), le fichier <code>NEWS.md</code> pour un historique du package (section “Changelog”) et des informations du fichier <code>DESCRIPTION</code>.</p>
<p>Créer le site avec <strong>usethis</strong> :</p>
<p></p>
<div class="sourceCode" id="cb370"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_pkgdown.html">use_pkgdown</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Construire ensuite le site.
Cette commande sera exécutée à nouveau à chaque changement de version du package :</p>
<p></p>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu">build_site</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Le site est placé dans le dossier <code>docs</code>.
Ouvrir le fichier <code>index.htm</code> avec un navigateur web pour le visualiser.
Dès que le projet sera poussé sur GitHub, activer les pages du dépôt pour que le site soit visible en ligne (voir section <a href="chap-git.html#sec:github-pages">3.7</a>).</p>
<p><strong>pkgdown</strong> place le site dans le dossier <code>docs</code>.</p>
<p>Ajouter l’adresse des pages GitHub dans une nouvelle ligne du fichier <code>DESCRIPTION</code> :</p>
<pre><code>URL: https://GitHubID.github.io/multiple</code></pre>
<p>L’ajouter aussi dans le fichier <code>_pkgdown.yml</code> qui a été créé vide, ainsi que l’option suivante :</p>
<pre><code>url: https://GitHubID.github.io/multiple

development:
  mode: auto</code></pre>
<p><strong>pkgdown</strong> place le site dans le dossier <code>docs/dev</code> si le site d’une version stable (à trois nombres) du package existe dans <code>docs</code> et que la version en cours est une version de développement (à quatre nombres).
De cette façon, les utilisateurs d’une version de production du package ont accès au site sans qu’il soit perturbé par les versions de développement.</p>
<p>Le site peut être enrichi de plusieurs façons :</p>
<ul>
<li>En ajoutant des articles au format R Markdown dans le dossier <code>vignettes/articles</code>.
La vignette ne peut pas mobiliser d’importantes ressources de calcul pour présenter des exemples parce qu’elle est construite en même temps que le package.
Les articles sont générés par <strong>pkgdown</strong>, indépendamment, et peuvent donc être plus <span style="white-space:nowrap">ambitieux ;</span>
</li>
<li>En améliorant sa présentation (regroupement des fonctions par thèmes, ajout de badges, d’un sticker<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;L’application Shiny &lt;strong&gt;hexmake&lt;/strong&gt; permet de créer facilement un sticker : &lt;a href="https://connect.thinkr.fr/hexmake/" class="uri"&gt;https://connect.thinkr.fr/hexmake/&lt;/a&gt;&lt;/p&gt;'><sup>103</sup></a>…) : se référer à la vignette de <strong>pkgdown</strong>.</li>
</ul>
<p>Pour enrichir la documentation du package, il est possible d’utiliser un fichier <code>README.Rmd</code> au format R Markdown, à tricoter pour créer le <code>README.md</code> standard de GitHub, utilisé comme page d’accueil du site <strong>pkgdown</strong>, qui peut de cette façon présenter des exemples d’utilisation du code.
La démarche est détaillée dans <em>R Packages</em><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r-pkgs.org/release.html?q=readme#readme-rmd" class="uri"&gt;https://r-pkgs.org/release.html?q=readme#readme-rmd&lt;/a&gt;&lt;/p&gt;'><sup>104</sup></a>.
La complexité ajoutée est à comparer au gain obtenu : une page d’accueil simple (sans code) avec des liens vers la vignette et les articles est plus simple à mettre en œuvre.</p>
</div>
<div id="code-spécifique-aux-packages" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Code spécifique aux packages<a class="anchor" aria-label="anchor" href="#code-sp%C3%A9cifique-aux-packages"><i class="fas fa-link"></i></a>
</h2>
<div id="importation-de-fonctions" class="section level3" number="5.5.1">
<h3>
<span class="header-section-number">5.5.1</span> Importation de fonctions<a class="anchor" aria-label="anchor" href="#importation-de-fonctions"><i class="fas fa-link"></i></a>
</h3>
<p>Créons une nouvelle fonction dans <code>fonctions.R</code> qui ajoute un bruit aléatoire à la valeur double :</p>
<p></p>
<div class="sourceCode" id="cb374"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fuzzydouble</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">sd</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Le bruit est tiré dans une loi normale centrée d’écart-type <code>sd</code> et ajouté à la valeur calculée.</p>
<p><code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> est une fonction du package <strong>stats</strong>.
Même si le package est systématiquement chargé par R, le package d’appartenance de la fonction doit obligatoirement être déclaré : les seules exceptions sont les fonctions du package <strong>base</strong>.</p>
<p>Le package <strong>stats</strong> doit d’abord être déclaré dans <code>DESCRIPTION</code> qui contient une instruction <code>Imports:</code>.
Tous les packages utilisés par le code de <strong>multiple</strong> seront listés, séparés par des virgules.</p>
<pre><code>Imports: stats</code></pre>
<p>Cette “importation” signifie simplement que le package <strong>stats</strong> doit être chargé, mais pas nécessairement attaché (voir section <a href="chap-utiliseR.html#sec:environnements">2.2</a>), pour que <strong>multiple</strong> fonctionne.</p>
<p>Ensuite, la fonction <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> doit être trouvable dans l’environnement du package <strong>multiple</strong>.
Il y a plusieurs façons de remplir cette obligation.
D’abord, le commentaire suivant pourrait être fourni pour <strong>roxygen2</strong> :</p>
<p></p>
<div class="sourceCode" id="cb376"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @import stats</span></span></code></pre></div>
<p></p>
<p>Tout l’espace de nom du package <strong>stats</strong> serait attaché et accessible au package <strong>multiple</strong>.
Ce n’est pas une bonne pratique parce qu’elle multiplie les risques de conflits de noms (voir section <a href="chap-utiliseR.html#sec:environnements">2.2</a>).
Notons que la notion d’importation utilisée ici est différente de celle de <code>DESCRIPTION</code>, bien qu’elles aient le même nom.</p>
<p>Il est préférable d’importer uniquement la fonction <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> en la déclarant dans la documentation de la fonction :</p>
<p></p>
<div class="sourceCode" id="cb377"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom stats rnorm</span></span></code></pre></div>
<p></p>
<p>Ce n’est pas une pratique idéale non plus parce que l’origine de la fonction n’apparaîtrait pas clairement dans le code du package.</p>
<p>La bonne pratique est de ne rien importer (au sens de <strong>roxygen2</strong>) et de qualifier systématiquement les fonctions d’autres packages avec la syntaxe <code>package::fonction()</code>.
C’est la solution retenue ici parce que la directive <code>@importFrom</code> importerait la fonction dans tout le package <strong>multiple</strong>, pas seulement dans la fonction <code>fuzzydouble()</code>, au risque de créer des effets de bord (modifier le comportement d’une autre fonction du package qui n’assumerait pas l’importation de <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>).
Finalement, le code de la fonction est le suivant :</p>
<p></p>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' fuzzydouble</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Double value of numbers with an error</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Calculate the double values of numbers </span></span>
<span><span class="co">#' and add a random error to the result.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param number a numeric vector.</span></span>
<span><span class="co">#' @param sd the standard deviation of the Gaussian error added.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A vector of the same length as `number`</span></span>
<span><span class="co">#'  containing the transformed values.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' fuzzydouble(2)</span></span>
<span><span class="co">#' fuzzydouble(1:4)</span></span>
<span><span class="va">fuzzydouble</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">sd</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span> <span class="op">+</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
</div>
<div id="méthodes-s3" class="section level3" number="5.5.2">
<h3>
<span class="header-section-number">5.5.2</span> Méthodes S3<a class="anchor" aria-label="anchor" href="#m%C3%A9thodes-s3"><i class="fas fa-link"></i></a>
</h3>
<p>Les méthodes S3 sont présentées en section <a href="chap-utiliseR.html#sec:S3">2.1.2</a>.</p>
<div id="classes" class="section level4" number="5.5.2.1">
<h4>
<span class="header-section-number">5.5.2.1</span> Classes<a class="anchor" aria-label="anchor" href="#classes"><i class="fas fa-link"></i></a>
</h4>
<p>Les objets appartiennent à des classes :</p>
<p></p>
<div class="sourceCode" id="cb379"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Classe d'un nombre</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb381"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Classe d'une fonction</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "function"</code></pre>
<p></p>
<p>En plus des classes de base, les développeurs peuvent en créer d’autres.</p>
</div>
<div id="méthodes" class="section level4" number="5.5.2.2">
<h4>
<span class="header-section-number">5.5.2.2</span> Méthodes<a class="anchor" aria-label="anchor" href="#m%C3%A9thodes"><i class="fas fa-link"></i></a>
</h4>
<p>L’intérêt de créer de nouvelles classes est de leur adapter des méthodes existantes, le cas le plus courant étant <code><a href="https://rdrr.io/r/base/plot.html">plot()</a></code>.
Il s’agit d’une méthode générique, c’est-à-dire un modèle de fonction, sans code, à décliner selon la classe d’objet à traiter.</p>
<p></p>
<div class="sourceCode" id="cb383"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot</span></span></code></pre></div>
<pre><code>## function (x, y, ...) 
## UseMethod("plot")
## &lt;bytecode: 0x7fe163bbb718&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>Il existe dans R de nombreuses déclinaisons de <code>plot</code> qui sont des fonctions dont le nom est de la forme <code>plot.class()</code>.
<strong>stats</strong> fournit une fonction <code>plot.lm()</code> pour créer une figure à partir d’un modèle linéaire.
De nombreux packages créent des classes adaptées à leurs objets et proposent une méthode <code>plot</code> pour chaque classe.
Les fonctions peuvent être listées :</p>
<p></p>
<div class="sourceCode" id="cb385"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Quelques fonctions plot()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="va">plot</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "plot,ANY-method"   "plot,color-method"
## [3] "plot.AccumCurve"   "plot.acf"         
## [5] "plot.ACF"          "plot.addvar"</code></pre>
<div class="sourceCode" id="cb387"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Nombre total</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="va">plot</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 154</code></pre>
<p></p>
<p>Inversement, les méthodes disponibles pour une classe peuvent être affichées :</p>
<p></p>
<div class="sourceCode" id="cb389"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] add1           alias          anova         
##  [4] as_flextable   case.names     coerce        
##  [7] confint        cooks.distance deviance      
## [10] dfbeta         dfbetas        drop1         
## [13] dummy.coef     effects        extractAIC    
## [16] family         formula        fortify       
## [19] hatvalues      influence      initialize    
## [22] kappa          labels         logLik        
## [25] model.frame    model.matrix   nobs          
## [28] plot           predict        print         
## [31] proj           qqnorm         qr            
## [34] residuals      response       rstandard     
## [37] rstudent       show           simulate      
## [40] slotsFromS3    summary        variable.names
## [43] vcov          
## see '?methods' for accessing help and source code</code></pre>
<p></p>
<p>La méthode <code>print</code> est utilisée pour afficher tout objet (elle est implicite quand on saisit seulement le nom d’un objet) :</p>
<p></p>
<div class="sourceCode" id="cb391"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">dist</span> <span class="op">~</span> <span class="va">speed</span>, data <span class="op">=</span> <span class="va">cars</span><span class="op">)</span></span>
<span><span class="co"># Equivalent de '&gt; my_lm'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">my_lm</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = dist ~ speed, data = cars)
## 
## Coefficients:
## (Intercept)        speed  
##     -17.579        3.932</code></pre>
<p></p>
<p>La méthode <code>summary</code> affiche un résumé lisible de l’objet :</p>
<p></p>
<div class="sourceCode" id="cb393"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">my_lm</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = dist ~ speed, data = cars)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -29.069  -9.525  -2.272   9.215  43.201 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -17.5791     6.7584  -2.601   0.0123 *  
## speed         3.9324     0.4155   9.464 1.49e-12 ***
## ---
## Signif. codes:  
## 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 15.38 on 48 degrees of freedom
## Multiple R-squared:  0.6511, Adjusted R-squared:  0.6438 
## F-statistic: 89.57 on 1 and 48 DF,  p-value: 1.49e-12</code></pre>
<p></p>
<p>Les autres méthodes ont été créées spécifiquement pour les besoins du package <strong>stats</strong>.</p>
</div>
<div id="attribution-dun-objet-à-une-classe" class="section level4" number="5.5.2.3">
<h4>
<span class="header-section-number">5.5.2.3</span> Attribution d’un objet à une classe<a class="anchor" aria-label="anchor" href="#attribution-dun-objet-%C3%A0-une-classe"><i class="fas fa-link"></i></a>
</h4>
<p>Pour qu’un objet appartient à une classe, il suffit de le déclarer :</p>
<p></p>
<div class="sourceCode" id="cb395"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"MyClass"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "MyClass"</code></pre>
<p></p>
<p>Une façon plus élégante de le faire est d’ajouter la nouvelle classe à l’ensemble des classes auquel l’objet appartient déjà :</p>
<p></p>
<div class="sourceCode" id="cb397"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MyClass"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "MyClass" "numeric"</code></pre>
<p></p>
<p>Il n’y a aucune vérification de cohérence entre la structure réelle de l’objet et une structure de la classe qui serait déclarée ailleurs : le développeur doit s’assurer que les méthodes trouveront bien les bonnes données dans les objets qui déclarent lui appartenir.
Dans le cas contraire, des erreurs se produisent :</p>
<p></p>
<div class="sourceCode" id="cb399"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"lm"</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;simpleError in x$call: $ operator is invalid for atomic vectors&gt;</code></pre>
<p></p>
</div>
</div>
<div id="en-pratique" class="section level3" number="5.5.3">
<h3>
<span class="header-section-number">5.5.3</span> En pratique<a class="anchor" aria-label="anchor" href="#en-pratique"><i class="fas fa-link"></i></a>
</h3>
<div id="création-dune-méthode-générique" class="section level4" number="5.5.3.1">
<h4>
<span class="header-section-number">5.5.3.1</span> Création d’une méthode générique<a class="anchor" aria-label="anchor" href="#cr%C3%A9ation-dune-m%C3%A9thode-g%C3%A9n%C3%A9rique"><i class="fas fa-link"></i></a>
</h4>
<p>De nouvelles méthodes génériques peuvent être créées et déclinées selon les classes.</p>
<p>A titre d’exemple, créons une méthode générique <code>triple</code> qui calculera le triple des valeurs dans le package <strong>multiple</strong>, déclinée en deux fonctions distinctes : une pour les entiers et une pour les réels.
Les calculs sur les nombres entiers plus rapides que ceux sur les réels, ce qui justifie l’effort d’écrire deux versions du code.</p>
<p></p>
<div class="sourceCode" id="cb401"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Méthode générique</span></span>
<span><span class="va">triple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span><span class="op">(</span><span class="st">"triple"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>La méthode générique ne contient pas de code au-delà de sa déclaration.
Sa signature (c’est-à-dire l’ensemble de ses arguments) est importante parce que les fonctions dérivées de cette méthode devront obligatoirement avoir les mêmes arguments dans le même ordre et pourront seulement ajouter des arguments supplémentaires avant <code>...</code> (qui est obligatoire).
Comme la nature du premier argument dépendra de la classe de chaque objet, l’usage est de l’appeler <code>x</code>.</p>
<p>La méthode est déclinée en deux fonctions :</p>
<p></p>
<div class="sourceCode" id="cb402"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">triple.integer</span><span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">3L</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">triple.numeric</span><span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">3.0</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Dans sa version entière, <code>x</code> est multiplié par <code>3L</code>, le suffixe <code>L</code> signifiant que 3 doit être compris comme un entier.
Dans sa version réelle, 3 peut être noté <code>3.0</code> pour montrer clairement qu’il s’agit d’un réel.
Sous R, <code>3</code> sans autre précision est compris comme un réel.</p>
<p>Le choix de la fonction dépend de la classe de l’objet passé en argument.</p>
<p></p>
<div class="sourceCode" id="cb403"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Argument entier</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode" id="cb405"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Résultat entier par la fonction triple.integer</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">triple</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode" id="cb407"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Argument réel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb409"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Résultat réel par la fonction triple.numeric</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">triple</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb411"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Performance</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">triple.integer</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span>, <span class="fu">triple.numeric</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="fu">triple</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Unit: nanoseconds
##                expr  min   lq     mean median     uq
##  triple.integer(2L)  288  298   318.29  304.5  312.0
##   triple.numeric(2)  289  302 14983.34  309.0  319.0
##          triple(2L) 1048 1060 18646.33 1070.0 1117.5
##      max neval
##     1037   100
##  1466266   100
##  1753326   100</code></pre>
<p></p>
<p>La mesure des performances par le package <strong>microbenchmark</strong> ne montre pas de différence entre les fonctions <code>triple.integer()</code> et <code>triple.numeric</code> comme attendu parce que le temps consacré au calcul lui-même est négligeable en comparaison du temps d’appel de la fonction.
La méthode générique consomme beaucoup plus de temps que les calculs très simples ici.
R teste en effet l’existence de fonctions correspondant à la classe de l’objet passé en argument aux méthodes génériques.
Comme un objet peut appartenir à plusieurs classes, il recherche une fonction adaptée à la première classe, puis aux classes suivantes successivement.
Cette recherche prend beaucoup de temps et justifie de réserver l’usage de méthodes génériques à la lisibilité du code plutôt qu’à une recherche de performance : l’intérêt des méthodes génériques est de fournir à l’utilisateur du code une seule fonction pour un objectif donné (<code>plot</code> pour réaliser une figure) quelles que soient les données à traiter.</p>
</div>
<div id="création-dune-classe" class="section level4" number="5.5.3.2">
<h4>
<span class="header-section-number">5.5.3.2</span> Création d’une classe<a class="anchor" aria-label="anchor" href="#cr%C3%A9ation-dune-classe"><i class="fas fa-link"></i></a>
</h4>
<p>Dans un package, on créera des classes si les résultats des fonctions le justifient : structure de liste et identification de la classe à un objet (“lm” est la classe des modèles linéaires).
Pour toute classe créée, les méthodes <code>print</code>, <code>summary</code> et <code>plot</code> (si une représentation graphique est possible) doivent être écrites.</p>
<p>Ecrivons une fonction <code>multiple()</code> dont le résultat sera un objet d’une nouvelle classe, “multiple”, qui sera une liste mémorisant les valeurs à multiplier, le multiplicateur et le résultat.</p>
<p></p>
<div class="sourceCode" id="cb413"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">times</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Calculate the multiples</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">number</span> <span class="op">*</span> <span class="va">times</span></span>
<span>    <span class="co"># Save in a list</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">number</span>, y <span class="op">=</span> <span class="va">y</span>, times <span class="op">=</span> <span class="va">times</span><span class="op">)</span></span>
<span>    <span class="co"># Set the class</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"multiple"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Classe du résultat</span></span>
<span><span class="va">my_multiple</span> <span class="op">&lt;-</span> <span class="fu">multiple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "multiple" "list"</code></pre>
<p></p>
<p>L’appel à la fonction <code>multiple()</code> renvoie un objet de classe “multiple”, qui est aussi de classe “list”.
En absence de fonction <code>print.multiple()</code>, R cherche la fonction <code>print.list()</code> qui n’existe pas et se rabat sur la fonction <code><a href="https://rdrr.io/r/base/print.default.html">print.default()</a></code> :</p>
<p></p>
<div class="sourceCode" id="cb415"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_multiple</span></span></code></pre></div>
<pre><code>## $x
## [1] 1 2 3
## 
## $y
## [1] 2 4 6
## 
## $times
## [1] 2
## 
## attr(,"class")
## [1] "multiple" "list"</code></pre>
<p></p>
<p>La fonction <code>print.multiple</code> doit donc être écrite pour un affichage lisible, limité au résultat :</p>
<p></p>
<div class="sourceCode" id="cb417"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Nouvel affichage</span></span>
<span><span class="va">my_multiple</span></span></code></pre></div>
<pre><code>## [1] 2 4 6</code></pre>
<p></p>
<p>Les détails peuvent être présentés dans la fonction <code>summary</code> :</p>
<p></p>
<div class="sourceCode" id="cb419"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"multiplied by"</span>, <span class="va">object</span><span class="op">$</span><span class="va">times</span>, <span class="st">"is:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Nouvel affichage</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1 2 3
## multiplied by 2 is:
## [1] 2 4 6</code></pre>
<p></p>
<p>Enfin, une fonction <code>plot</code> et une fonction <code>autoplot</code> complètent l’ensemble :</p>
<p></p>
<div class="sourceCode" id="cb421"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot.default</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">y</span>, x<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">x</span>, type <span class="op">=</span> <span class="st">"p"</span>, </span>
<span>    main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, <span class="va">x</span><span class="op">$</span><span class="va">times</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">autoplot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, </span>
<span>                                <span class="va">object</span><span class="op">$</span><span class="va">times</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/plot.multiple-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb422"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="travailleR_files/figure-html/plot.multiple-2.png" width="80%" style="display: block; margin: auto;"></div>
<p></p>
<p>Pour des raisons techniques liées à l’évaluation non conventionnelle dans le tidyverse, les noms de variables utilisées par <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> doivent être préfixées par <code>.data$</code> dans les packages et <code><a href="https://rlang.r-lib.org/reference/dot-data.html">rlang::.data</a></code> doit être importé.
Dans le cas contraire, la vérification du package renvoie une note indiquant que les variables <code>x</code> et <code>y</code>, utilisées par les arguments de <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> n’ont pas été déclarées et n’existent peut-être pas dans l’environnement local (voir section <a href="chap-utiliseR.html#sec:environnements">2.2</a>).</p>
</div>
<div id="documentation" class="section level4" number="5.5.3.3">
<h4>
<span class="header-section-number">5.5.3.3</span> Documentation<a class="anchor" aria-label="anchor" href="#documentation"><i class="fas fa-link"></i></a>
</h4>
<p>Les méthodes génériques et les fonctions qui les déclinent doivent être documentées comme n’importe quelle autre fonction.</p>
<p>La gestion de l’espace des noms est un peu plus complexe :</p>
<ul>
<li>Les méthodes génériques doivent être exportées :</li>
</ul>
<pre><code>#' @export</code></pre>
<ul>
<li>Les fonctions dérivées de méthodes génériques ne doivent pas être exportées mais être déclarées comme méthodes, avec le nom de la méthode générique et la classe traitée.
<strong>roxygen2</strong> demande qu’une directive d’exportation soit ajoutée mais ne l’applique pas (comme il se doit) dans le fichier <code>NAMESPACE</code> qui est utilisé par R :</li>
</ul>
<pre><code>#' @method plot multiple
#' @export</code></pre>
<ul>
<li><p>Depuis la version 3 de <strong>roxygen2</strong>, la déclaration <code>@method</code> est inutile tant que le nom de la fonction est décomposable sans ambiguïté, comme <code>plot.multiple</code> : <code>@export</code> suffit.
Si le nom de la fonction dérivée comporte plusieurs points, <strong>roxygen2</strong> peut ne pas détecter automatiquement le générique et l’objet et <code>@method</code> doit être maintenu.</p></li>
<li><p>Les fonctions dérivées de méthodes génériques venant d’un autre package nécessitent d’importer la méthode générique, sauf si elle est fournie par <strong>base</strong> (<code>print</code> est fourni par <strong>base</strong> et n’est donc pas concerné) :</p></li>
</ul>
<pre><code>#' @importFrom graphics plot
#' @importFrom ggplot2 autoplot</code></pre>
<ul>
<li>Les génériques importés de cette manière doivent être réexportés par une directive à placer par exemple juste après le code de la fonction dérivée :</li>
</ul>
<pre><code><a href="https://rdrr.io/r/graphics/plot.default.html">#' @export
graphics::plot

#' @export
ggplot2::autoplot</a></code></pre>
<ul>
<li>
<strong>roxygen2</strong> crée automatiquement un fichier d’aide <code>reexports.Rd</code> dans lequel se trouve un lien vers la documentation originale des génériques réexportés.</li>
</ul>
<p>Dans <code>DESCRIPTION</code>, le package d’origine de chaque générique doit être listé dans la directive <code>Imports:</code> :</p>
<pre><code>Imports: ggplot2, graphics</code></pre>
<p>Enfin, l’importation de fonctions du tidyverse nécessite aussi quelques précautions :</p>
<ul>
<li>le package <strong>tidyverse</strong> est réservé à l’usage interactif de R : il n’est pas question de l’importer dans <code>DESCRIPTION</code> parce que ses dépendances peuvent changer et aboutir à des résultats imprévisibles.
Le package <strong>magrittr</strong> fournit les tuyaux, principalement <code>%&gt;%</code>.
Le package <strong>rlang</strong> fournit l’objet <code>.data</code> présenté ci-dessous.
Il doivent être importés dans <code>DESCRIPTION</code>.</li>
</ul>
<pre><code>Imports: magrittr, rlang, stats</code></pre>
<ul>
<li>Comme il n’est pas possible de préfixer les <code>%&gt;%</code> par le nom du package, il faut importer la fonction en utilisant les délimiteurs prévus pour les fonctions dont le nom contient des caractères spéciaux :</li>
</ul>
<p></p>
<div class="sourceCode" id="cb429"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom magrittr `%&gt;%`</span></span></code></pre></div>
<p></p>
<ul>
<li>Les fonctions du tidyverse qui utilisent des noms de colonnes de tibbles ou dataframes génèrent des avertissements au moment de la vérification du package parce que ces noms sont confondus avec des noms de variables non définies.
Pour éviter cette confusions, l’objet <code>.data</code> du package <strong>rlang</strong> est utilisé (par exemple dans <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> vu plus haut).
Il doit être importé :</li>
</ul>
<p></p>
<div class="sourceCode" id="cb430"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom rlang .data</span></span></code></pre></div>
<p></p>
<p>Finalement, le code complet est le suivant :</p>
<p></p>
<div class="sourceCode" id="cb431"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Multiplication of a numeric vector</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param number a numeric vector</span></span>
<span><span class="co">#' @param times a number to multiply</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return an object of class `multiple`</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' multiple(1:2,3)</span></span>
<span><span class="va">multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">times</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate the multiples</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">number</span> <span class="op">*</span> <span class="va">times</span></span>
<span>  <span class="co"># Save in a list</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">number</span>, y <span class="op">=</span> <span class="va">y</span>, times <span class="op">=</span> <span class="va">times</span><span class="op">)</span></span>
<span>  <span class="co"># Set the class</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"multiple"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Print objects of class multiple</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x an object of class `multiple`.</span></span>
<span><span class="co">#' @param ... further arguments passed to the generic method.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' print(multiple(2,3))</span></span>
<span><span class="va">print.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Summarize objects of class multiple</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param object an object of class `multiple`.</span></span>
<span><span class="co">#' @param ... further arguments passed to the generic method.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' summary(multiple(2,3))</span></span>
<span><span class="va">summary.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"multiplied by"</span>, <span class="va">object</span><span class="op">$</span><span class="va">times</span>, <span class="st">"is:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Plot objects of class multiple</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x a vector of numbers</span></span>
<span><span class="co">#' @param y a vector of multiplied numbers</span></span>
<span><span class="co">#' @param ... further arguments passed to the generic method.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @importFrom graphics plot</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' plot(multiple(2,3))</span></span>
<span><span class="va">plot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot.default</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">y</span>, x<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">x</span>, type <span class="op">=</span> <span class="st">"p"</span>, </span>
<span>               main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, <span class="va">x</span><span class="op">$</span><span class="va">times</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="fu">graphics</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span></span></code></pre></div>
<pre><code>## function (x, y, ...) 
## UseMethod("plot")
## &lt;bytecode: 0x7fe163bbb718&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<div class="sourceCode" id="cb433"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' autoplot</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' ggplot of the `multiple` objects.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param object an object of class `multiple`.</span></span>
<span><span class="co">#' @param ... ignored.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return a `ggplot` object</span></span>
<span><span class="co">#' @importFrom ggplot2 autoplot</span></span>
<span><span class="co">#' @importFrom magrittr `%&gt;%`</span></span>
<span><span class="co">#' @importFrom rlang .data</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' autoplot(multiple(2,3))</span></span>
<span><span class="va">autoplot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, </span>
<span>                                <span class="va">object</span><span class="op">$</span><span class="va">times</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span></span></code></pre></div>
<pre><code>## function (object, ...) 
## {
##     UseMethod("autoplot")
## }
## &lt;bytecode: 0x7fe16576d7d0&gt;
## &lt;environment: namespace:ggplot2&gt;</code></pre>
<p></p>
</div>
</div>
<div id="code-c" class="section level3" number="5.5.4">
<h3>
<span class="header-section-number">5.5.4</span> Code C++<a class="anchor" aria-label="anchor" href="#code-c"><i class="fas fa-link"></i></a>
</h3>
<p>L’utilisation de code C++ a été vue en section <a href="chap-utiliseR.html#sec:cpp">2.5</a>.
Pour intégrer ces fonctions dans un packages, il faut respecter les règles suivantes :</p>
<ul>
<li>les fichiers <code>.cpp</code> contenant le code sont placés dans le dossier <code>/src</code> du <span style="white-space:nowrap">projet ;</span>
</li>
<li>le code est commenté pour <strong>roxygen2</strong> de la même façon que les fonctions R, mais avec le marqueur de commentaire du langage C :</li>
</ul>
<p></p>
<div class="sourceCode" id="cb435"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb435-1"><a href="chap-package.html#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb435-2"><a href="chap-package.html#cb435-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb435-3"><a href="chap-package.html#cb435-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-4"><a href="chap-package.html#cb435-4" aria-hidden="true" tabindex="-1"></a><span class="co">//' timesTwo</span></span>
<span id="cb435-5"><a href="chap-package.html#cb435-5" aria-hidden="true" tabindex="-1"></a><span class="co">//'</span></span>
<span id="cb435-6"><a href="chap-package.html#cb435-6" aria-hidden="true" tabindex="-1"></a><span class="co">//' Calculates the double of a value.</span></span>
<span id="cb435-7"><a href="chap-package.html#cb435-7" aria-hidden="true" tabindex="-1"></a><span class="co">//'</span></span>
<span id="cb435-8"><a href="chap-package.html#cb435-8" aria-hidden="true" tabindex="-1"></a><span class="co">//' @param x A numeric vector.</span></span>
<span id="cb435-9"><a href="chap-package.html#cb435-9" aria-hidden="true" tabindex="-1"></a><span class="co">//' @export</span></span>
<span id="cb435-10"><a href="chap-package.html#cb435-10" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb435-11"><a href="chap-package.html#cb435-11" aria-hidden="true" tabindex="-1"></a>NumericVector timesTwo<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb435-12"><a href="chap-package.html#cb435-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb435-13"><a href="chap-package.html#cb435-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<ul>
<li>dans <code>DESCRIPTION</code>, importer les packages.
<strong>Rcpp</strong>, et <strong>RcppParallel</strong> si du code parallélisé est utilisé (supprimer ses références sinon), doivent être déclarés dans <code>LinkingTo</code> :</li>
</ul>
<pre><code>Imports: Rcpp, RcppParallel
LinkingTo: Rcpp, RcppParallel</code></pre>
<ul>
<li>les commentaires pour <strong>roxygen2</strong> doivent être ajoutés à <code>package.R</code> (“multiple” est le nom du package) :</li>
</ul>
<p></p>
<div class="sourceCode" id="cb437"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom Rcpp sourceCpp</span></span>
<span><span class="co">#' @importFrom RcppParallel RcppParallelLibs</span></span>
<span><span class="co">#' @useDynLib multiple, .registration = TRUE</span></span></code></pre></div>
<p></p>
<ul>
<li>les fichiers de travail de C++ sont exclus du contrôle de source dans <code>.gitignore</code> :</li>
</ul>
<pre><code># C binaries
src/*.o
src/*.so
src/*.dll</code></pre>
<p>Ces modifications sont en partie effectuées automatiquement, pour <strong>Rcpp</strong> seulement, par <strong>usethis</strong>, mais l’insertion manuelle du code est plus rapide et fiable : ne pas utiliser cette commande.</p>
<p></p>
<div class="sourceCode" id="cb439"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># usethis::use_rcpp()</span></span></code></pre></div>
<p></p>
<p>La construction du package entraînera la compilation du code : les Rtools sont donc indispensables.</p>
</div>
<div id="package-bien-rangé" class="section level3" number="5.5.5">
<h3>
<span class="header-section-number">5.5.5</span> Package bien rangé<a class="anchor" aria-label="anchor" href="#package-bien-rang%C3%A9"><i class="fas fa-link"></i></a>
</h3>
<p>Tout package moderne doit être compatible avec le tidyverse, ce qui nécessite peu d’efforts :</p>
<ul>
<li>pour permettre l’utilisation de pipelines, l’argument principal des fonctions doit être le <span style="white-space:nowrap">premier ;</span>
</li>
<li>les fonctions qui transforment des données doivent accepter un dataframe ou un tibble comme premier argument et retourner un objet du même <span style="white-space:nowrap">format ;</span>
</li>
<li>les méthodes <code><a href="https://rdrr.io/r/base/plot.html">plot()</a></code> doivent être doublées de méthodes <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> avec les mêmes arguments qui produisent le même graphique avec <strong>ggplot2</strong>.</li>
</ul>
</div>
</div>
<div id="bibliographie-1" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> Bibliographie<a class="anchor" aria-label="anchor" href="#bibliographie-1"><i class="fas fa-link"></i></a>
</h2>
<p>La documentation d’un package fait appel à des références bibliographiques.
Elles peuvent être gérées automatiquement avec <strong>Rdpack</strong> et <strong>roxygen2</strong>.
Les références utilisées dans les fichiers R Markdown (vignette, site produit par <strong>pkgdown</strong>) ne sont pas concernées.</p>
<div id="préparation" class="section level3" number="5.6.1">
<h3>
<span class="header-section-number">5.6.1</span> Préparation<a class="anchor" aria-label="anchor" href="#pr%C3%A9paration"><i class="fas fa-link"></i></a>
</h3>
<p>Les références bibliographiques doivent être placées dans un fichier bibtex <code>REFERENCES.bib</code> placé dans le dossier <code>inst</code>.
Ce dossier contient des fichiers qui seront placés à la racine du dossier du package quand il sera installé.</p>
<p>Ajouter la ligne suivante à <code>DESCRIPTION</code> :</p>
<pre><code>RdMacros: Rdpack</code></pre>
<p>Ajouter aussi le package <code>Rdpack</code> à la liste des packages importés :</p>
<pre><code>Imports: magrittr, stats, Rcpp, Rdpack</code></pre>
<p>Enfin, importer la fonction <code>reprompt()</code> de <strong>Rdpack</strong> en ajoutant les lignes suivantes à la documentation pour <strong>roxygen2</strong> dans <code>package.R</code> :</p>
<p></p>
<div class="sourceCode" id="cb442"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom Rdpack reprompt</span></span></code></pre></div>
<p></p>
</div>
<div id="citations" class="section level3" number="5.6.2">
<h3>
<span class="header-section-number">5.6.2</span> Citations<a class="anchor" aria-label="anchor" href="#citations"><i class="fas fa-link"></i></a>
</h3>
<p>Les références sont citées par la commande <code>\insertCite{key}{package}</code> dans la documentation destinée à <strong>roxygen2</strong>.
<code>package</code> est le nom du package dans lequel le fichier <code>REFERENCES.bib</code> doit être cherché : ce sera normalement le package en cours, mais les références d’autres packages sont accessibles, à la seule condition qu’ils utilisent <strong>Rdpack</strong>.</p>
<p><code>key</code> est l’identifiant de la référence dans le fichier.
Exemple<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Package &lt;strong&gt;divent&lt;/strong&gt; sur GitHub : &lt;a href="https://github.com/EricMarcon/divent/blob/master/R/package.R" class="uri"&gt;https://github.com/EricMarcon/divent/blob/master/R/package.R&lt;/a&gt;&lt;/p&gt;'><sup>105</sup></a>: documentation du package <strong>divent</strong> hébergé sur GitHub, fichier <code>.R</code> du package :</p>
<p></p>
<div class="sourceCode" id="cb443"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' divent</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Measures of Diversity and Entropy</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' This package is a reboot of the **entropart** package \insertCite{Marcon2014c}{divent}.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @importFrom Rdpack reprompt</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @references</span></span>
<span><span class="co">#' \insertAllCited{}</span></span>
<span><span class="st">"_PACKAGE"</span></span></code></pre></div>
<pre><code>## [1] "_PACKAGE"</code></pre>
<p></p>
<p>La référence citée se trouve dans <code>inst/REFERENCES.bib</code> :</p>
<pre><code>@Article{Marcon2014c,
  author  = {Marcon, Eric and Herault, Bruno},
  title   = {entropart, an R Package to Partition 
             Diversity},
  journal = {Journal of Statistical Software},
  year    = {2015},
  volume  = {67},
  number  = {8},
  pages   = {1--26},
}</code></pre>
<p>Les citations sont entre parenthèses.
Pour placer le nom de l’auteur hors de la parenthèse, ajouter la déclaration <code>;textual</code> :</p>
<pre><code>\insertCite{Marcon2014c;textual}{divent}</code></pre>
<p>Pour citer plusieurs références (forcément du même package), les séparer par des virgules.</p>
<p>A la fin de la documentation d’un objet utilisant des citations, ajouter systématiquement une liste des références :</p>
<p></p>
<div class="sourceCode" id="cb447"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @references</span></span>
<span><span class="co">#' \insertAllCited{}</span></span></code></pre></div>
<p></p>
</div>
</div>
<div id="données" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> Données<a class="anchor" aria-label="anchor" href="#donn%C3%A9es"><i class="fas fa-link"></i></a>
</h2>
<p>Des données peuvent être intégrées à un package, notamment pour la clarté des exemples.</p>
<p>La méthode la plus simple consiste à utiliser <strong>usethis</strong>.
Créer des variables contenant les données à sauvegarder puis les sauvegarder :</p>
<p></p>
<div class="sourceCode" id="cb448"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seq1_10</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">seq1_100</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data</a></span><span class="op">(</span><span class="va">seq1_10</span>, <span class="va">seq1_100</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Un fichier <code>.rda</code> est créé dans le dossier <code>data</code> pour chaque variable créée.
Avec l’option <code>LazyData</code> activée dans <code>DESCRIPTION</code>, les variables seront disponibles dès le chargement du package, mais ne seront effectivement chargées en mémoire qu’après leur première utilisation.</p>
<p>Chaque variable doit être documentée dans le fichier <code>package.R</code> :</p>
<p></p>
<div class="sourceCode" id="cb449"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' seq1_10</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' A sequence of numbers from 1 to 10</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @format A numeric vector.</span></span>
<span><span class="co">#' @source Values computed by the R software, </span></span>
<span><span class="co">#'   \url{https://www.r-project.org/}</span></span>
<span><span class="st">"seq1_10"</span></span></code></pre></div>
<p></p>
<p>Le nom de la variable est donné entre guillemets après le bloc de commentaires (à la place du code R d’une fonction).
<code>@format</code> décrit le format des données et <code>@source</code> permet d’indiquer leur source.</p>
</div>
<div id="tests-unitaires" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> Tests unitaires<a class="anchor" aria-label="anchor" href="#tests-unitaires"><i class="fas fa-link"></i></a>
</h2>
<p>Dans l’idéal, tout le code inclus dans un package devrait être testé de multiples façons :</p>
<ul>
<li>contre les erreurs de syntaxe : les procédures de vérification de R s’en chargent assez <span style="white-space:nowrap">bien ;</span>
</li>
<li>pour vérifier la conformité des résultats de calculs aux valeurs <span style="white-space:nowrap">attendues ;</span>
</li>
<li>contre la survenue d’erreurs si les utilisateurs n’utilisent pas le code comme le développeur l’a prévu (arguments incorrects passés aux fonctions, données inadéquates…).</li>
</ul>
<p>Les tests unitaires sont utilisés dans les deux derniers objectifs.
Ils s’appuient sur <strong>testthat</strong> à intégrer au package :</p>
<p></p>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_testthat.html">use_testthat</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p></p>
<pre><code>## 
## Attaching package: 'testthat'</code></pre>
<pre><code>## The following object is masked from 'package:targets':
## 
##     matches</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     matches</code></pre>
<pre><code>## The following object is masked from 'package:purrr':
## 
##     is_null</code></pre>
<pre><code>## The following objects are masked from 'package:readr':
## 
##     edition_get, local_edition</code></pre>
<pre><code>## The following object is masked from 'package:tidyr':
## 
##     matches</code></pre>
<p></p>
<p>Les tests doivent être ajoutés sous la forme de fichiers <code>.R</code> dont le nom commence obligatoirement par <code>test</code> dans le dossier <code>tests/testthat</code>.</p>
<p>Chaque test (donc le contenu de chaque fichier) commence par son contexte, c’est-à-dire ce un ensemble de tests. Exemple, dans un fichier <code>test_double.R</code> :</p>
<p></p>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">context</span><span class="op">(</span><span class="st">"function double"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Les tests sont contenus dans des fichiers qui les regroupent par thème, par exemple <code>test_double.R</code>.
Le nom de chaque test est passé comme argument de la fonction <code>test_that()</code> :</p>
<p></p>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Double values are correct"</span>, <span class="op">{</span></span>
<span>    <span class="fu">skip_on_cran</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span></span>
<span>    <span class="co"># 2 x 2 should be 4</span></span>
<span>    <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># The result should be a number (type = 'double')</span></span>
<span>    <span class="fu">expect_type</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"double"</span><span class="op">)</span></span>
<span>    <span class="co"># Error management</span></span>
<span>    <span class="fu">expect_error</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Test passed 🎊</code></pre>
<p></p>
<p>Toutes les fonctions commençant par <code>expect</code> permettent de comparer leur premier argument à un résultat : dans l’exemple ci-dessus, le résultat de <code>double(1:2)</code> doit être <code>2 4</code> et le type de ce vecteur doit être réel à double précision.
Le dernier test vérifie qu’une chaîne de caractère passée comme argument génère une erreur, ce qui n’est pas optimal : si le package traitait l’erreur, le message retourné pourrait être testé.</p>
<p>La commande <code>skip_on_cran()</code>, à utiliser systématiquement, évite de lancer les tests sur CRAN quand le package y sera déposé : CRAN dispose de ressources limitées et restreint strictement le temps de vérification des packages sur sa plateforme.
Les tests devront donc être réalisés sur GitHub, grâce à l’intégration continue, voir section <a href="chap-package.html#sec:package-ci5">5.10</a>.</p>
<p>Les tests peuvent être lancés par le menu “More &gt; Test package” de la fenêtre <em>Build</em> ou par la commande <code>devtools::test()</code>.</p>
<p>Il est conseillé d’écrire les tests dès qu’une fonction du package est stabilisée.</p>
</div>
<div id="fichier-.gitignore" class="section level2" number="5.9">
<h2>
<span class="header-section-number">5.9</span> Fichier .gitignore<a class="anchor" aria-label="anchor" href="#fichier-.gitignore"><i class="fas fa-link"></i></a>
</h2>
<p>Le fichier <code>.gitignore</code> obtenu à ce stade est incomplet.
Il peut être remplacé par celui-ci :</p>
<pre><code># History files
.Rhistory
.Rapp.history
# Session Data files
.RData
# Example code in package build process
*-Ex.R
# Output files from R CMD build
/*.tar.gz
# Output files from R CMD check
/*.Rcheck/
# RStudio files
.Rproj.user/
.Rprofile
# knitr and R markdown default cache directories
*_cache/
/cache/
# Temporary files created by R markdown
*.utf8.md
*.knit.md
# C binaries
src/*.o
src/*.so
src/*.dll
/src-i386/
/src-x64/
# uncomment if pkgdown is run by CI
# docs/</code></pre>
<p>La dernière ligne concerne le dossier <code>docs/</code>, qui reçoit le site web produit par <strong>pkgdown</strong>.
Elle est commentée tant que la production du site est réalisée localement, mais décommentée si elle est confiée à GitHub Actions (voir section suivante).</p>
</div>
<div id="sec:package-ci5" class="section level2" number="5.10">
<h2>
<span class="header-section-number">5.10</span> Intégration continue<a class="anchor" aria-label="anchor" href="#sec:package-ci5"><i class="fas fa-link"></i></a>
</h2>
<p>La vérification (<em>Check</em>) du package doit être effectuée à chaque étape du développement, ce qui consomme un temps considérable.
Elle peut être automatisée très simplement avec le service GitHub Actions, déclenché à chaque modification du dépôt sur GitHub.
L’analyse de la couverture du code par les tests (quelles parties du codes sont testées ou non) sera ajoutée.</p>
<p>GitHub est également capable de reconstruire la documentation du package avec <strong>pkgdown</strong>, autre opération consommatrice de ressources, après la réussite des tests.</p>
<p>La section <a href="chap-ci.html#sec:package-ci6">6.3.3</a> détaille le moyen de le faire.</p>
</div>
<div id="sec:package-cran" class="section level2" number="5.11">
<h2>
<span class="header-section-number">5.11</span> CRAN<a class="anchor" aria-label="anchor" href="#sec:package-cran"><i class="fas fa-link"></i></a>
</h2>
<p>Les packages dont l’audience dépasse l’entourage de l’auteur peuvent être déposés sur CRAN.
Les règles à respecter sur CRAN sont nombreuses<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://cran.r-project.org/web/packages/policies.html" class="uri"&gt;https://cran.r-project.org/web/packages/policies.html&lt;/a&gt;&lt;/p&gt;'><sup>106</sup></a>. Elles sont vérifiées par la commande de vérification <code>R CMD check</code> avec l’option <code>-- as.cran</code>.
La vérification ne doit renvoyer aucune erreur, aucun avertissement, ni aucune note avant de soumettre le package.</p>
<div id="test-du-package" class="section level3" number="5.11.1">
<h3>
<span class="header-section-number">5.11.1</span> Test du package<a class="anchor" aria-label="anchor" href="#test-du-package"><i class="fas fa-link"></i></a>
</h3>
<p>La vérification du package par GitHub dans le cadre de l’intégration continue n’est pas suffisante.
Le package doit être testé sur la version de développement de R.
Le site <em>R-hub builder</em><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://builder.r-hub.io/" class="uri"&gt;https://builder.r-hub.io/&lt;/a&gt;&lt;/p&gt;'><sup>107</sup></a> permet de le faire simplement.</p>
<p>Le package, dont la version ne doit pas être de développement (limitée à trois nombres, voir section <a href="chap-package.html#sec:package-description">5.2.1</a>), doit être construit au format source : dans la fenêtre <em>Build</em> de RStudio, cliquer sur “More &gt; Build Source Package”.
Sur le site <em>R-hub builder</em>, cliquer sur “Advanced”, sélectionner le fichier source du package et la plateforme de test : <em>Debian Linux, R-devel, GCC</em>.</p>
<p>Le package <strong>rhub</strong> permet d’utiliser la même plateforme de vérification que le site <em>R-hub builder</em> depuis RStudio.
La première étape consiste à valider son adresse de messagerie avec la commande <code>validate_email()</code>.
Ensuite, il suffit d’appeler la fonction <code>check_for_cran()</code> pour lancer une vérification complète.</p>
</div>
<div id="soumission" class="section level3" number="5.11.2">
<h3>
<span class="header-section-number">5.11.2</span> Soumission<a class="anchor" aria-label="anchor" href="#soumission"><i class="fas fa-link"></i></a>
</h3>
<p>Quand le package est au point, la soumission à CRAN se fait par le site web dédié<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://xmpalantir.wu.ac.at/cransubmit/" class="uri"&gt;https://xmpalantir.wu.ac.at/cransubmit/&lt;/a&gt;&lt;/p&gt;'><sup>108</sup></a>.</p>
<p>En cas de rejet, traiter les demandes et soumettre à nouveau en incrémentant le numéro de version.</p>
</div>
<div id="maintenance" class="section level3" number="5.11.3">
<h3>
<span class="header-section-number">5.11.3</span> Maintenance<a class="anchor" aria-label="anchor" href="#maintenance"><i class="fas fa-link"></i></a>
</h3>
<p>Des demandes de corrections sont envoyées par CRAN de temps à autre, notamment lors des changements de version de R.
L’adresse de messagerie du responsable du package (<em>maintainer</em>) doit rester valide et les demandes doivent être traitées rapidement.
Dans le cas contraire, le package est archivé.</p>
<p>Les nouvelles versions du package sont soumises de la même façon que la première.</p>

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="chap-rediger.html"><span class="header-section-number">4</span> Rédiger</a></div>
<div class="next"><a href="chap-ci.html"><span class="header-section-number">6</span> Intégration continue</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-package"><span class="header-section-number">5</span> Package</a></li>
<li>
<a class="nav-link" href="#premier-package"><span class="header-section-number">5.1</span> Premier package</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#cr%C3%A9ation"><span class="header-section-number">5.1.1</span> Création</a></li>
<li><a class="nav-link" href="#premi%C3%A8re-fonction"><span class="header-section-number">5.1.2</span> Première fonction</a></li>
<li><a class="nav-link" href="#sec:package-cds"><span class="header-section-number">5.1.3</span> Contrôle de source</a></li>
<li><a class="nav-link" href="#package.r"><span class="header-section-number">5.1.4</span> package.R</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#organisation-du-package"><span class="header-section-number">5.2</span> Organisation du package</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec:package-description"><span class="header-section-number">5.2.1</span> Fichier DESCRIPTION</a></li>
<li><a class="nav-link" href="#fichier-news.md"><span class="header-section-number">5.2.2</span> Fichier NEWS.md</a></li>
</ul>
</li>
<li><a class="nav-link" href="#vignette"><span class="header-section-number">5.3</span> Vignette</a></li>
<li><a class="nav-link" href="#pkgdown"><span class="header-section-number">5.4</span> pkgdown</a></li>
<li>
<a class="nav-link" href="#code-sp%C3%A9cifique-aux-packages"><span class="header-section-number">5.5</span> Code spécifique aux packages</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#importation-de-fonctions"><span class="header-section-number">5.5.1</span> Importation de fonctions</a></li>
<li><a class="nav-link" href="#m%C3%A9thodes-s3"><span class="header-section-number">5.5.2</span> Méthodes S3</a></li>
<li><a class="nav-link" href="#en-pratique"><span class="header-section-number">5.5.3</span> En pratique</a></li>
<li><a class="nav-link" href="#code-c"><span class="header-section-number">5.5.4</span> Code C++</a></li>
<li><a class="nav-link" href="#package-bien-rang%C3%A9"><span class="header-section-number">5.5.5</span> Package bien rangé</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#bibliographie-1"><span class="header-section-number">5.6</span> Bibliographie</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#pr%C3%A9paration"><span class="header-section-number">5.6.1</span> Préparation</a></li>
<li><a class="nav-link" href="#citations"><span class="header-section-number">5.6.2</span> Citations</a></li>
</ul>
</li>
<li><a class="nav-link" href="#donn%C3%A9es"><span class="header-section-number">5.7</span> Données</a></li>
<li><a class="nav-link" href="#tests-unitaires"><span class="header-section-number">5.8</span> Tests unitaires</a></li>
<li><a class="nav-link" href="#fichier-.gitignore"><span class="header-section-number">5.9</span> Fichier .gitignore</a></li>
<li><a class="nav-link" href="#sec:package-ci5"><span class="header-section-number">5.10</span> Intégration continue</a></li>
<li>
<a class="nav-link" href="#sec:package-cran"><span class="header-section-number">5.11</span> CRAN</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#test-du-package"><span class="header-section-number">5.11.1</span> Test du package</a></li>
<li><a class="nav-link" href="#soumission"><span class="header-section-number">5.11.2</span> Soumission</a></li>
<li><a class="nav-link" href="#maintenance"><span class="header-section-number">5.11.3</span> Maintenance</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/EricMarcon/travailleR/blob/master/05-PackageR.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/EricMarcon/travailleR/edit/master/05-PackageR.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Travailler avec R</strong>" was written by Eric Marcon. It was last built on 20/12/2023.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
